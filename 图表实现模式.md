# 图表实现模式（p10 总结）

以 `charts/p10` 的最新实现为基线，统一说明图表的数据契约、填充流程与构建合成方式，便于后续批量完成其他页。

## 目标与原则
- 数据与样式一致：保证 PPT 图表的“数值、标签、样式”与模板口径一致；只替换需要更新的图表。
- 复用与可维护：各页遵循统一目录与脚本入口；通用填充器只关心“契约化数据”。
- 安全与回退：缺失数据保留模板缓存；保留原始快照，异常时可回滚。

## 目录结构（以 `charts/p10` 为例）
- `chart8/`、`chart9/`：每个图表一个目录
- `chart_path.txt`：指向被填充的目标 XML（如 `ppt/input/LRTBH-unzip/ppt/charts/chart8.xml`）
  - `final_data.json`：优先读取的最终数据（自动生成或人工修订）
  - `data.json`：原始生成数据（当 `final_data.json` 不存在时作为回退）
  - `original_*.json`：模板解析的原始缓存快照（如 `original_series.json`、`original_scatter.json`）
  - `fill.py`：读取 JSON 并调用通用填充器写入图表 XML
  - `preview_original.png`：离线预览图（不依赖 HTTP）
- 脚本入口
  - `make_data.py`：从 DB 生成 `chart8/chart9` 的 `data.json` 与 `final_data.json`（含缺失回退）
  - `build_all.py`：页面级串联（生成数据 → 填充图表 → 构建修改版与原始版 → 预览）
  - `build.py` / `build_original.py`：单页 PPTX 构建（复制 slide10 相关资源，补齐布局/母版）

## 数据来源与口径
- 配置文件：`compute_metrics.yaml` 与 `charts/config.yaml`
  - 时间范围：`update.start_date` 与 `update.end_date`（如 `2025-08-01` 至 `2025-08-31`）
  - 国家与品牌：`filters.countryId`、`filters.brand_key`、`filters.brands` 与展示顺序 `brands_display`
  - 渠道映射：`charts/config.yaml` 的 `channels` 将来源归并到目标渠道（如 Online News、Forum…）
  - 填充策略：`fill_policy.keep_original_for_missing`、`fill_policy.axis_day_base`（默认 `20300`）等
- 数据库：
  - 指标库：`data/metrics_v5.db`（主数据源）
  - 舆情库：`data/neticle-v5.sqlite`（可辅助对齐或补数）

## 图表类型与数据契约（p10）
- Chart8（饼图 / Share of Voice by Channel）
  - 含义：各渠道占比（mentions 或 weighted mentions）
  - JSON 契约（二选一，填充器自动兼容）：
    - 完整：`{labels:[...], series:[{values:[...]}, ...]}`
    - 简写：`list[list]` 或单系列 `list[float]`
  - 示例：
    ```json
    {
      "labels": ["Online News", "Forum", "Blog", "X", "Instagram", "YouTube"],
      "series": [{"values": [42, 13, 8, 28, 6, 3]}]
    }
    ```
- Chart9（散点/折线 / Daily Trend by Brand）
  - 含义：按日趋势（y 为数值；x 由脚本按日序生成）
  - JSON 契约（任一形式）：
    - 列表：`list[{name, x, y, points}]`（`y` 或 `points=[[x,y],...]`）
    - 对象：`{scatter_series:[{name, y, points}, ...]}`
    - 简写：单系列 `list[float]`
  - 示例：
    ```json
    {
      "scatter_series": [
        {"name": "Lenovo", "y": [3, 4, 2, 5, 6]},
        {"name": "Dell", "y": [2, 2, 3, 4, 3]}
      ]
    }
    ```

## 通用填充器与回退策略
- 通用填充：`charts/tools/fill_chart_xml.py`
  - 类别型图（line/bar/pie/doughnut/area）：写 `c:cat` 的 `strRef/strLit` 与各系列 `c:val` 的 `numRef/numLit`
  - 散点图：写 `c:yVal` 与 `c:xVal`（`xVal = axis_day_base + 1 + i` 递增）
- 缺失数据回退（`fill_policy.keep_original_for_missing = true`）
  - 类别型：按原始标签顺序对齐；新标签追加在末尾；缺失值用模板缓存
  - 散点：`y` 缺失用原始 `y`；`x` 为新数据段按日生成，旧段保留模板 `x`
- 轴基准（`fill_policy.axis_day_base`）
  - 默认 `20300`；最终生成 `xVal` 从 `20301` 起按日递增

## 页面级流水线（p10 最新）
- `python3 charts/p10/build_all.py --mode both`
  - 生成数据：`make_data.py` → 写入 `chart8/chart9` 的 `data.json` 和 `final_data.json`
- 填充图表：`chart8/fill.py`、`chart9/fill.py` → 更新 `ppt/input/LRTBH-unzip/ppt/charts/chart*.xml`
  - 构建单页：`build.py`（修改版 `charts/output/p10.pptx`）、`build_original.py`（原始版 `charts/output/p10-original.pptx`）
  - 预览生成：`gen_preview.py`（离线 PNG，用原始快照）
- 全局合成：
  - 修改版：`python3 charts/tools/build_all.py --skip-pages` → 输出 `charts/output/LRTBH-final.pptx`
    - 替换范围：`charts/p10/config.yaml` 的 `output.replace_charts: ["chart8.xml","chart9.xml"]`
    - 模式：`final_mode: updated`（仅替换指定图表，其他保持模板）
  - 原始版：`python3 charts/tools/build_all_original.py` → 输出 `charts/output/LRTBH-final-original.pptx`

## 配置项约定（关键条目）
- `charts/config.yaml`
- `project.template_root`: `ppt/input/LRTBH-unzip`
  - `project.output_root`: `charts/output`
  - `update.start_date`: 开始日期（`YYYY-MM-DD`）
  - `update.end_date`: 结束日期（`YYYY-MM-DD`）
  - `data_sources.metrics_db`: `../data/metrics_v5.db`
  - `filters.countryId`、`filters.brands`、`brands_display`
  - `channels`: 来源到目标渠道映射
  - `fill_policy.keep_original_for_missing`、`fill_policy.axis_day_base`
  - `output.final_ppt`、`output.final_mode`
- `charts/p10/config.yaml`
  - `output.replace_charts`: 仅 p10 需要替换的图表（`chart8.xml`、`chart9.xml`）
  - `fill_policy.axis_day_base`: p10 局部覆盖（如与模板不一致时）

## 质量保障与校验
- 包结构校验：`python3 charts/tools/check_pptx.py`
- 解压校验：`python3 charts/tools/verify_unzip.py`（生成 `charts/output/verify_unzip.json` 与 `verify_unzip.md`）
- 页面验证：`python3 charts/p10/validate.py`
- 全量验证：`python3 charts/tools/validate_all.py`
- 预览：`python3 charts/p10/gen_preview.py`（离线 PNG，不启用 HTTP）

## 扩展到其他页的建议流程
1. 复制 `charts/p10` 为新页目录（或使用脚手架 `python3 charts/tools/scaffold_p10.py`）
2. 为每个图表建立子目录：`chartX/`，写入 `chart_path.txt` 指向目标 `chartX.xml`
3. 实现该页的 `make_data.py`（遵循本页数据契约），生成 `data.json` 与 `final_data.json`
4. 编写 `chartX/fill.py`：读取 JSON → 调用通用填充器 `fill_chart_xml.py`
5. 更新新页的 `config.yaml`：`output.replace_charts` 列出需要替换的图表；必要时覆盖 `fill_policy`
6. 串联页面脚本：`build_all.py` 在生成数据后调用各 `chartX/fill.py`，然后构建单页与原始页
7. 使用 `charts/tools/build_all.py` 合成最终 PPT（确保全局配置与新页配置一致）

## 注意事项与最佳实践
- 保证 DB 文件存在（`data/metrics_v5.db`、必要时 `data/neticle-v5.sqlite`）
- `compute_metrics.yaml` 的品牌顺序与展示名需与模板一致，避免标签错位
- 散点图多系列长度不一致时，遵循“新数据优先、缺失补原始”的规则
- 轴基准与模板要一致；如需要局部覆盖，请在该页 `config.yaml` 中设置
- 不在构建过程中启用 HTTP 预览或下载，避免干扰；预览仅生成本地 PNG

---

以上模式以 p10 为准线。后续页面只需保持相同的“数据契约 + 填充入口 + 构建串联”，即可快速扩展并确保质量一致。