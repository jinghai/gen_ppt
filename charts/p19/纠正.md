# P19 纠正说明（图表理解、指标与口径）

- 核对依据：`input/LRTBH-images/p19.png`、`charts/p19/readme.md`、`charts/p19/chart29/original_meta.json`、`config.yaml`、`make_data.py`。

## 图表理解纠正
- 实际仅包含 1 个图表：`chart29.xml`，类型为 `lineChart`（见 `original_meta.json`）。
- `readme.md` 中将本页描述为“类别图（7 品牌 SOV）+ 趋势图（Lenovo vs Others）”的组合，会造成误解。本页并不存在单独的 SOV 类别图，只有“Lenovo vs Others”的日级趋势折线/散点表现。
- 结论：请将“类别图：7 品牌 SOV分析（饼/柱/面积/环形）”从本页说明中移除，保留“趋势图：Lenovo vs Others 日级对比（折线/散点）”。

## 正确的数据口径与计算方法
- 数据源：`brand_metrics_day`（日级明细）。
- 品牌集合：由全局配置 `config.yaml -> filters.brands` 决定，基准品牌优先 `lenovo`。
- X 轴：日期按 `axis_day_base` 偏移映射为数值，配置为 `20300`。映射公式：
  - `x[i] = axis_day_base + i + 1`，`i` 为从起始日期开始的日序号（0 基）。
- Y 轴：品牌提及数（mentions）。
- 系列定义（见 `make_data.py::make_trend_lenovo_vs_others`）：
  - `Lenovo`：`y1[d] = sum(brand_mentions where day=d and brand=lenovo)`。
  - `Others`：`y2[d] = sum(brand_mentions where day=d and brand!=lenovo)`。

示意 SQL（聚合到日粒度后再拼装序列）：
```
SELECT day,
       SUM(CASE WHEN brand='lenovo' THEN brand_mentions ELSE 0 END) AS y_lenovo,
       SUM(CASE WHEN brand!='lenovo' THEN brand_mentions ELSE 0 END) AS y_others
FROM brand_metrics_day
WHERE day BETWEEN :start AND :end
  AND brand IN (:brands)
GROUP BY day
ORDER BY day;
```

## 可选新增指标与口径说明
- `Lenovo_7d_MA`、`Others_7d_MA`：7 日滚动均线，平滑波动，公式为过去 7 天的算术平均。
- `Lenovo_Share_Daily(%)`：`lenovo / (lenovo + others) * 100`，反映日级 SOV；与月度 SOV 含义不同，不要混用。
- `DoD(%)`：`(today - yesterday) / yesterday * 100`，用于识别日环比突变。
- `Peak/Valley 标注`：可用 3σ 或 IQR 异常检测在图中打标，便于定位活动/突发事件。

以上指标均可在 `make_data.py` 生成序列后计算并落入 `final_data.json`，保持与现有填充流程兼容（`fill.py` 已兼容 `lineChart` 以 `scatter_series` 形式填充）。

## 对 readme.md 的修订建议
- 页目标注：改为“本页为 Lenovo vs Others 的日级趋势图（lineChart），不包含 7 品牌 SOV 类别图”。
- 数据源与字段：保留日级表 `brand_metrics_day` 的说明；月度表 `brand_metrics_month` 不再作为本页必需数据源。
- 构建说明：保留 `make_data.py / build.py` 步骤；强调 `fill_policy.axis_day_base=20300` 与日期窗口来源于全局 `compute_metrics.yaml`。

## 一致性校验要点（供实现自检）
- `chart29.xml` 的类型应解析为 `lineChart`；如模板更换导致类型变动，需同步更新 `make_data.py` 的生成路径。
- `final_data.json` 使用 `scatter_series` 写入两条曲线即可兼容 `lineChart` 填充（现有 `fill.py` 已处理）。
- 日期范围与品牌集须与全局配置保持一致，避免不同页面间口径不一致。

---
本页纠正完成：去除了“类别图 SOV”混入本页的误导，明确为“Lenovo vs Others 日级趋势（lineChart）”，并补充了可选的新增指标与精确计算口径。