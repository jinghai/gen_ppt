# P10页面需求文档

## 页面概述

P10页面是Lenovo品牌在法国市场的情感分析报告页面，展示"Sentiment breakdown"（情感分布）数据。页面包含两个核心图表：情感分布饼图和情感趋势折线图。

## 数据需求

### 数据源
- **数据库**: neticle-v5-08.sqlite
- **数据表**: mentions_wide
- **时间范围**: 2025年8月7日至28日
- **地理范围**: 法国 (countryIsoCode2='fr')
- **品牌**: Lenovo (keyword_label LIKE '%lenovo%')

### 数据字段
- `polarity`: 情感极性值（用于情感分类）
- `createdAtUtcMs`: 时间戳（用于时间序列分析）
- `countryIsoCode2`: 国家代码（用于地理筛选）
- `keyword_label`: 关键词标签（用于品牌筛选）

## 情感分类规则

基于polarity字段进行三分类：
- **Positive（积极）**: polarity > 10
- **Neutral（中性）**: 0 ≤ polarity ≤ 10  
- **Negative（消极）**: polarity < 0

## 颜色配置规范

### 情感颜色映射
- **Positive（积极情感）**: `#4CAF50` (绿色)
- **Neutral（中性情感）**: `#FFC107` (黄色)  
- **Negative（消极情感）**: `#F44336` (红色)

### 颜色应用范围
- 饼图扇形区域填充色
- 折线图数据点和线条颜色
- 图例标识颜色
- 确保所有图表元素颜色一致性

## 图表需求

### 左侧饼图（Chart1）
- **图表类型**: 饼图
- **数据内容**: 整个时间段内三种情感的占比分布
- **数据计算**: 
  - 统计每种情感的总数量
  - 计算各情感占比（百分比）
- **颜色配置**: 
  - Positive: `#4CAF50` (绿色)
  - Neutral: `#FFC107` (黄色)
  - Negative: `#F44336` (红色)
- **图例**: 显示在饼图下方，包含颜色标识和标签

### 右侧折线图（Chart2）
- **图表类型**: 多线折线图
- **数据内容**: 每日三种情感的占比趋势
- **时间轴**: 2025年8月7日至28日（X轴）
- **数值轴**: 百分比0-100%（Y轴）
- **数据线配置**:
  - Positive线: `#4CAF50` (绿色)
  - Neutral线: `#FFC107` (黄色)  
  - Negative线: `#F44336` (红色)
- **数据计算**: 每日各情感占比 = 当日该情感数量 / 当日总数量 × 100%

## 技术实现要求

### 数据处理流程
1. **数据提取**: 从SQLite数据库提取符合条件的记录
2. **情感分类**: 基于polarity值进行三分类
3. **数据聚合**: 
   - 饼图：计算整体占比
   - 折线图：按日期分组计算每日占比
4. **Excel生成**: 将处理后的数据保存到Excel文件
5. **PPT填充**: 将Excel数据填充到PPT模板中

### 文件输出
- **Excel文件**: `p10_data.xlsx`
  - Sheet1: 饼图数据
  - Sheet2: 折线图数据  
  - Sheet3: 元数据信息
- **PPT文件**: `output/p10-final.pptx`
  - 基于模板生成的最终演示文稿

### 颜色一致性保证
- 所有图表元素必须使用统一的颜色配置
- 饼图和折线图的相同情感类别必须使用相同颜色
- 图例颜色必须与图表数据颜色保持一致
- 颜色值必须精确匹配指定的十六进制值

## 质量控制

### 数据验证
- 确保数据完整性（无缺失日期）
- 验证情感分类准确性
- 检查百分比计算正确性（总和为100%）

### 视觉验证  
- 验证颜色配置正确应用
- 确保图表可读性和美观性
- 检查图例与数据的对应关系

### 性能要求
- 数据处理时间 < 1秒
- 文件生成时间 < 2秒
- 支持自动化批量处理

## 技术实现方案

### 1. 数据提取 (generate_excel.py)
```python
# 主要SQL查询逻辑
# 1. 饼图数据
SELECT 
    CASE 
        WHEN polarity > 0 THEN 'Positive'
        WHEN polarity = 0 THEN 'Neutral' 
        ELSE 'Negative'
    END as sentiment,
    COUNT(*) as count
FROM mentions_wide 
WHERE countryIsoCode2='fr' AND keyword_label LIKE '%lenovo%'
GROUP BY sentiment;

# 2. 折线图数据  
SELECT 
    DATE(createdAtUtcMs/1000, 'unixepoch') as date,
    CASE 
        WHEN polarity > 0 THEN 'Positive'
        WHEN polarity = 0 THEN 'Neutral'
        ELSE 'Negative' 
    END as sentiment,
    COUNT(*) as count
FROM mentions_wide
WHERE countryIsoCode2='fr' AND keyword_label LIKE '%lenovo%'
    AND DATE(createdAtUtcMs/1000, 'unixepoch') BETWEEN '2025-08-07' AND '2025-08-28'
GROUP BY date, sentiment
ORDER BY date, sentiment;
```

### 2. Excel输出格式
**Sheet1: 饼图数据**
| Sentiment | Count | Percentage |
|-----------|-------|------------|
| Positive  | 1234  | 37.2%      |
| Neutral   | 1823  | 55.1%      |
| Negative  | 255   | 7.7%       |

**Sheet2: 折线图数据**
| Date       | Positive | Neutral | Negative |
|------------|----------|---------|----------|
| 2025-08-07 | 45.2%    | 52.1%   | 2.7%     |
| 2025-08-08 | 42.8%    | 54.3%   | 2.9%     |
| ...        | ...      | ...     | ...      |

### 3. PPT模板处理 (fill_from_excel.py)
- 解压PPT模板到 `tmp/` 目录
- 定位图表数据文件 (chart.xml, data.xlsx等)
- 替换图表数据源
- 更新图表缓存
- 重新打包生成最终PPT

## 配置要求

### 页面级配置文件 (config.yaml)
```yaml
# P10页面专用配置
project:
  name: "P10-Sentiment-Analysis"
  template_file: "p10.pptx"
  output_dir: "output"

data:
  country_code: "fr"
  country_name: "France" 
  brand_keyword: "lenovo"
  date_range:
    start: "2025-08-07"
    end: "2025-08-28"

charts:
  pie_chart:
    title: "Sentiment Distribution"
    labels: ["Positive", "Neutral", "Negative"]
    colors: ["#4CAF50", "#FFC107", "#F44336"]
  
  line_chart:
    title: "Daily Sentiment Trends"
    x_axis: "Date"
    y_axis: "Percentage (%)"
    lines: ["Positive", "Neutral", "Negative"]

output:
  excel_file: "p10_data.xlsx"
  final_ppt: "p10-final.pptx"
```

## 文件结构
```
charts/p10/
├── config.yaml          # 页面级配置
├── generate_excel.py    # 数据提取脚本
├── fill_from_excel.py   # PPT填充脚本  
├── build.py            # 构建脚本
├── p10.pptx            # 原始模板
├── p10_data.xlsx       # 生成的数据文件
├── tmp/                # 临时工作目录
│   └── ppt_extracted/  # 解压的PPT文件
├── output/             # 输出目录
│   └── p10-final.pptx  # 最终PPT
├── 需求.md             # 本文档
└── readme.md           # 项目说明
```

## 质量要求

1. **数据准确性**: 确保情感分类逻辑正确，时间范围准确
2. **模板保真**: 保持原始PPT模板的格式、字体、颜色等
3. **可编辑性**: 生成的PPT中图表数据可在PowerPoint中编辑
4. **人工验证**: Excel文件便于人工检查和修改数据
5. **错误处理**: 处理数据缺失、格式异常等情况

## 验收标准

1. 生成的Excel文件数据正确且格式清晰
2. 最终PPT保持模板样式，图表数据已更新
3. 饼图显示正确的情感分布比例
4. 折线图显示正确的时间趋势
5. PPT文件可正常打开和编辑
6. 构建过程可重复执行

## 注意事项

1. 不直接修改原始模板文件 `p10.pptx`
2. 使用页面级临时目录，避免污染根目录
3. 页面级配置独立，不依赖全局配置
4. 处理时区转换 (UTC -> 本地时间)
5. 考虑数据量大小，优化查询性能