# P10页面需求文档 - Lenovo法国市场情感分析

## 项目概述

本项目旨在基于现有数据库生成Lenovo品牌在法国市场的情感分析PPT页面，包含情感分布饼图和情感趋势折线图。

## 数据源

### 主要数据库
- **neticle数据库**: `/Users/jinghai/coder/gen_ppt/input/neticle-v5-08.sqlite`
  - 主表: `mentions_wide` (推荐使用的wide表)
  - 包含法国数据: `countryIsoCode2='fr'` (68,748条记录)
  - Lenovo相关数据: `keyword_label LIKE '%lenovo%'` (5,557条记录)

- **metrics数据库**: `/Users/jinghai/coder/gen_ppt/input/metrics_v5-08.db`
  - 备用聚合数据源

### 数据字段映射

#### 情感分析字段
- **polarity**: 情感极性分数 (-30.5 到 35 的连续值)
- **情感分类规则**:
  - Positive (积极): polarity > 0
  - Neutral (中性): polarity = 0  
  - Negative (消极): polarity < 0

#### 时间字段
- **createdAtUtcMs**: 创建时间戳(毫秒)
- **时间范围**: 1753999200000 到 1756676460000 (约2025年8月)

#### 筛选字段
- **countryIsoCode2**: 国家代码 ('fr' = 法国)
- **keyword_label**: 品牌标签 ('Lenovo-FR-V5')

## 图表需求

### 1. 左侧饼图 - 情感分布
**数据需求**:
- 统计整个时间段内Lenovo在法国的情感分布
- 计算三类情感的占比: Positive, Neutral, Negative
- 数据格式: 百分比

**预期结果**:
- Neutral: ~55%
- Positive: ~37% 
- Negative: ~8%

### 2. 右侧折线图 - 情感趋势
**数据需求**:
- 按日统计2025年8月7日-28日的情感分布
- 三条线分别代表: Positive, Neutral, Negative
- Y轴: 百分比 (0-100)
- X轴: 日期

**预期特征**:
- Neutral线: 20-100波动，整体下降趋势
- Positive线: 10-70波动，有明显峰值
- Negative线: 0-30波动，相对稳定

## 技术实现方案

### 1. 数据提取 (generate_excel.py)
```python
# 主要SQL查询逻辑
# 1. 饼图数据
SELECT 
    CASE 
        WHEN polarity > 0 THEN 'Positive'
        WHEN polarity = 0 THEN 'Neutral' 
        ELSE 'Negative'
    END as sentiment,
    COUNT(*) as count
FROM mentions_wide 
WHERE countryIsoCode2='fr' AND keyword_label LIKE '%lenovo%'
GROUP BY sentiment;

# 2. 折线图数据  
SELECT 
    DATE(createdAtUtcMs/1000, 'unixepoch') as date,
    CASE 
        WHEN polarity > 0 THEN 'Positive'
        WHEN polarity = 0 THEN 'Neutral'
        ELSE 'Negative' 
    END as sentiment,
    COUNT(*) as count
FROM mentions_wide
WHERE countryIsoCode2='fr' AND keyword_label LIKE '%lenovo%'
    AND DATE(createdAtUtcMs/1000, 'unixepoch') BETWEEN '2025-08-07' AND '2025-08-28'
GROUP BY date, sentiment
ORDER BY date, sentiment;
```

### 2. Excel输出格式
**Sheet1: 饼图数据**
| Sentiment | Count | Percentage |
|-----------|-------|------------|
| Positive  | 1234  | 37.2%      |
| Neutral   | 1823  | 55.1%      |
| Negative  | 255   | 7.7%       |

**Sheet2: 折线图数据**
| Date       | Positive | Neutral | Negative |
|------------|----------|---------|----------|
| 2025-08-07 | 45.2%    | 52.1%   | 2.7%     |
| 2025-08-08 | 42.8%    | 54.3%   | 2.9%     |
| ...        | ...      | ...     | ...      |

### 3. PPT模板处理 (fill_from_excel.py)
- 解压PPT模板到 `tmp/` 目录
- 定位图表数据文件 (chart.xml, data.xlsx等)
- 替换图表数据源
- 更新图表缓存
- 重新打包生成最终PPT

## 配置要求

### 页面级配置文件 (config.yaml)
```yaml
# P10页面专用配置
project:
  name: "P10-Sentiment-Analysis"
  template_file: "p10.pptx"
  output_dir: "output"

data:
  country_code: "fr"
  country_name: "France" 
  brand_keyword: "lenovo"
  date_range:
    start: "2025-08-07"
    end: "2025-08-28"

charts:
  pie_chart:
    title: "Sentiment Distribution"
    labels: ["Positive", "Neutral", "Negative"]
    colors: ["#4CAF50", "#FFC107", "#F44336"]
  
  line_chart:
    title: "Daily Sentiment Trends"
    x_axis: "Date"
    y_axis: "Percentage (%)"
    lines: ["Positive", "Neutral", "Negative"]

output:
  excel_file: "p10_data.xlsx"
  final_ppt: "p10-final.pptx"
```

## 文件结构
```
charts/p10/
├── config.yaml          # 页面级配置
├── generate_excel.py    # 数据提取脚本
├── fill_from_excel.py   # PPT填充脚本  
├── build.py            # 构建脚本
├── p10.pptx            # 原始模板
├── p10_data.xlsx       # 生成的数据文件
├── tmp/                # 临时工作目录
│   └── ppt_extracted/  # 解压的PPT文件
├── output/             # 输出目录
│   └── p10-final.pptx  # 最终PPT
├── 需求.md             # 本文档
└── readme.md           # 项目说明
```

## 质量要求

1. **数据准确性**: 确保情感分类逻辑正确，时间范围准确
2. **模板保真**: 保持原始PPT模板的格式、字体、颜色等
3. **可编辑性**: 生成的PPT中图表数据可在PowerPoint中编辑
4. **人工验证**: Excel文件便于人工检查和修改数据
5. **错误处理**: 处理数据缺失、格式异常等情况

## 验收标准

1. 生成的Excel文件数据正确且格式清晰
2. 最终PPT保持模板样式，图表数据已更新
3. 饼图显示正确的情感分布比例
4. 折线图显示正确的时间趋势
5. PPT文件可正常打开和编辑
6. 构建过程可重复执行

## 注意事项

1. 不直接修改原始模板文件 `p10.pptx`
2. 使用页面级临时目录，避免污染根目录
3. 页面级配置独立，不依赖全局配置
4. 处理时区转换 (UTC -> 本地时间)
5. 考虑数据量大小，优化查询性能