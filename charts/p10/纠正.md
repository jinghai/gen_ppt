# P10 纠正说明（情感三分类：占比 + 日级走势）

依据页面图片（p10.png）与现有 README，对“图表理解、是否需要新增指标、指标与数据计算方法”进行校准与细化。

## 1. 图表理解纠正
- 页面主题：Lenovo 在所选国家/周期内的情感分布（三分类：Positive/Neutral/Negative）与日级占比趋势。
- 图表结构：
  - chart8：当期（三分类）占比饼图/环图（或等价饼图展示）。
  - chart9：三折线（正/中/负）按日占比或平滑占比随时间变化。
- 关键口径：
  - 占比是“各类提及量 / 当期总提及量（正+中+负）”；当分母为 0 时占比置为 0（或 NA，需与页面展示保持一致）。
  - X 轴使用 `axis_day_base + 序号`（XML 模板约束），但语义上等价于日序列；需确保最终显示刻度与日期映射一致。

## 2. 是否需要新增指标（建议）
- 净情感值（Net Sentiment）：`(Positive − Negative) / (Positive + Neutral + Negative)`，或“净情感量 = Positive − Negative”。
- 情感强度（Sentiment Intensity / CSI）：`(Positive% − Negative%) × 100`，便于快速评估倾向。
- 加权情感占比（Weighted by Engagement）：用 `engagements`（如点赞/评论/转发）替代或作为权重，得到“影响力层面”的情感结构。
- 渠道分层（By Channel）：分解到社媒/新闻/论坛/视频等，识别渠道差异。
- 异常日标注：自动标记异常点（活动/危机/热点），提升解释力。

## 3. 指标计算方法与公式
- 三分类占比（当期）：
  - `denom = pos + neu + neg`
  - `pos% = 100 * pos / denom`，`neu%`、`neg%` 同理（`denom=0` 时置 0 或 NA）。
- 日级占比：
  - 对 `brand_metrics_day` 的每日 `pos_t, neu_t, neg_t` 计算 `denom_t = pos_t + neu_t + neg_t`，再求三类占比。
- 平滑占比（7D 可配）：
  - `P_t = Σ_{i=t-w+1..t} pos_i`（`min_periods=1`），`N_t, NG_t` 同理；`DEN_t = P_t + N_t + NG_t`。
  - `pos%_t = 100 * P_t / DEN_t`，其余同理（`DEN_t=0` 时置 0 或 NA）。
- 净情感：
  - `NetSent% = (pos% − neg%)` 或 `NetSentVol = pos − neg`（两者择一展示）。

## 4. 数据口径与处理
- 时间与过滤：严格遵循 `config.yaml` 的 `countryId`、`brand_key` 与时间范围；多品牌时仅保留 Lenovo 的三分类。
- 缺失与异常：
  - 分母为 0 的日期保持在时间轴中（置 0/NA），以免折线断裂；并在说明处标注“无有效提及”。
  - 可对极端异常值做 winsorize（1%/99%）或 IQR 规则，稳定曲线。
- 渠道与去重：
  - 若底层数据包含多渠道，先在渠道内去重聚合，再合并；确保 `pos+neu+neg` 与总量一致性。
- 分类一致性：
  - 三分类由统一模型/规则产生；需记录版本与阈值（如朴素阈值 vs softmax argmax），确保可复现。

## 5. 示例 SQL / 伪代码
- 三分类当期占比（按月或指定区间）
  ```sql
  WITH agg AS (
    SELECT brand,
           SUM(positive_mentions) AS pos,
           SUM(neutral_mentions)  AS neu,
           SUM(negative_mentions) AS neg
    FROM brand_metrics_month
    WHERE countryId = :countryId
      AND month BETWEEN :m_start AND :m_end
      AND LOWER(brand) = LOWER(:brand_key)
  )
  SELECT 100.0 * pos / NULLIF(pos+neu+neg,0)  AS pos_pct,
         100.0 * neu / NULLIF(pos+neu+neg,0)  AS neu_pct,
         100.0 * neg / NULLIF(pos+neu+neg,0)  AS neg_pct
  FROM agg;
  ```
- 日级（可平滑）
  ```sql
  -- 明细
  SELECT day,
         positive_mentions  AS pos,
         neutral_mentions   AS neu,
         negative_mentions  AS neg
  FROM brand_metrics_day
  WHERE countryId = :countryId
    AND day BETWEEN :d_start AND :d_end
    AND LOWER(brand) = LOWER(:brand_key)
  ORDER BY day;
  ```
  滑窗在上层用窗口函数或在应用侧 Rolling 求和后再算占比。

## 6. 图表呈现修正
- 颜色：Positive 绿、Neutral 灰、Negative 红，固定映射，避免跨页偏差。
- 标签：饼图显示百分比与数值（可切换）；折线图支持“百分比/数量”视图切换。
- 说明：在图下方标注“口径：三分类占比（分母=正+中+负）；分母为 0 的日期显示为 0%/NA”。
- 可选：展示 `NetSent%` 的辅助折线或次坐标，强化整体倾向判断。

## 7. 校验清单
- 三分类求和≈100%（允许四舍五入误差）。
- 日级汇总与当期截面在同一期间可相互核对（累计占比与当期占比逻辑一致）。
- 0/NA 的处理与 README 描述一致；`original_*` 兜底逻辑可回放。

---
说明：若页面图像与以上理解存在差异（如存在其它附图或指标），请标注具体差异点，我会进一步修订口径与实现建议。