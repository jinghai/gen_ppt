页面：p13（情感分布 + 日级情感趋势）纠正与完善

一、图表理解纠正
- 图表组成与模板验证：模板 slide13 显式引用 chart10.xml 与 chart11.xml（另有一张图片与超链接），因此本页应包含“当月情感分布（饼/环/柱均可作为类别图）”与“日级情感趋势（散点/线）”两类图。代码也按 chart 类型自动分派：
  - chart10：类别图（pie/bar/area/doughnut 任一）
  - chart11：scatterChart 或 lineChart
- 数据来源与口径：
  - 类别图（chart10）：使用 `metrics_v5.db` → 表 `brand_metrics_month`，按 `month + countryId + brand` 聚合 `positive_mentions / neutral_mentions / negative_mentions`，再计算占比。
  - 趋势图（chart11）：使用 `metrics_v5.db` → 表 `brand_metrics_day`，在配置的日期窗口内（`start_date`~`end_date`）逐日聚合 P/N/NG 并转成百分比曲线。
- 归一化与小数位：两张图的百分比结果都使用“保留 1 位小数，并用残差补齐到 100.0”的规则。实现为 `_normalize_100`：先四舍五入到 1 位，再将残差加到最大分量，确保总和为 100.0。
- 维度与筛选：品牌取自 `config.yaml` 的 `filters.brand_key`（转小写后参与 SQL 过滤），国家用 `filters.countryId`，月份标签来自 `start_date` 的 `YYYY-MM`。
- X 轴映射（趋势图）：x 值按 `axis_day_base + i + 1` 映射（`i` 从 0 起计当天在窗口内的索引），用于与模板坐标系对齐；y 为当日 P/N/NG 的百分比。
- 缺失数据回退：
  - chart10：回退读取 `chart10/original_series.json`；
  - chart11：回退读取 `chart11/original_scatter.json`。
  无数据时趋势图按天补 0，类别图从回退文件取值。

二、需要新增/强化的指标
- 净情感分（Net Sentiment Score, NSS）：`NSS = Positive% - Negative%`。用于在类别图右侧以数值徽标展示，直观体现“好-坏”净差。
- 正负比（P/N Ratio）：`(positive_mentions + ε) / (negative_mentions + ε)`，建议 ε=1 防 0。用于业务判断风险（<1 表负面偏高）。
- 环比/同比的情感占比变化：对比上月（或去年同月）P/N/NG 的占比差异，展示 ΔPositive%、ΔNeutral%、ΔNegative%。
- 趋势图 7 日滑动均线（可选）：对三条序列各加一条 MA7 虚线，降低节假日与偶发事件造成的抖动。
- 互动效率（IPM）的可视化提示（可选）：代码已计算 `metrics.ipm_month` 与逐日 IPM；可在趋势图上用副轴细线叠加或在页角数卡展示，便于把“声量”和“互动质量”一起观察。
- 情感波动度（Volatility）：逐日 Positive% 的标准差，用于衡量舆情稳定性。

三、数据口径与计算方法（落地可复用）
1) 类别图（chart10，当月情感分布）
- 聚合：
  - 选择表：`brand_metrics_month`
  - 过滤条件：`month = substr(start_date, 1, 7)`、`countryId = filters.countryId`、`LOWER(brand) = LOWER(filters.brand_key)`
  - 指标：`p = SUM(positive_mentions)`，`n = SUM(neutral_mentions)`，`ng = SUM(negative_mentions)`
- 百分比：`vals = [p, n, ng] / (p + n + ng) * 100`，保留 1 位后按 `_normalize_100` 补残差。
- 标签顺序固定：`["Positive", "Neutral", "Negative"]`。

示例 SQL（SQLite）：
```sql
-- 月度情感分布
SELECT countryId, month, brand,
       SUM(COALESCE(positive_mentions,0)) AS positive_mentions,
       SUM(COALESCE(neutral_mentions,0))  AS neutral_mentions,
       SUM(COALESCE(negative_mentions,0)) AS negative_mentions
FROM brand_metrics_month
WHERE month = :month
  AND countryId = :countryId
  AND LOWER(brand) = :brand
GROUP BY countryId, month, brand;
```

2) 趋势图（chart11，日级情感趋势）
- 聚合：
  - 选择表：`brand_metrics_day`
  - 过滤条件：`start_date <= day <= end_date`、`countryId`、`LOWER(brand)`
  - 指标：逐日 `positive_mentions / neutral_mentions / negative_mentions`，缺失日补 0。
- 百分比：对每一日 `vals = [p, n, ng] / (p + n + ng) * 100`，保留 1 位并执行 `_normalize_100`。
- X 轴：`x_i = axis_day_base + i + 1`（i 为 0..N-1）。

示例 SQL（SQLite）：
```sql
-- 日级分布（原始计数）
SELECT day,
       SUM(COALESCE(positive_mentions,0)) AS positive_mentions,
       SUM(COALESCE(neutral_mentions,0))  AS neutral_mentions,
       SUM(COALESCE(negative_mentions,0)) AS negative_mentions
FROM brand_metrics_day
WHERE day >= :start_date AND day <= :end_date
  AND countryId = :countryId
  AND LOWER(brand) = :brand
GROUP BY day
ORDER BY day ASC;
```

3) 互动与 IPM（已在代码中计算，建议对外说明口径）
- `engagement_total_month = Σ_day(total_interactions)`
- `ipm_month = engagement_total_month / Σ_day(total_mentions)`（注意：不是逐日 IPM 的算术平均）
- 逐日 IPM：`ipm_day[d] = total_interactions[d] / total_mentions[d]`（分母为 0 时给 0）

四、缺失与异常数据处理（建议）
- 缺失日：当前逻辑补 0 并得到 0%；这对“占比”会拉低曲线。可增加配置项 `fill_policy.missing_day`：
  - `zeros`（当前）：缺失视为 0；
  - `previous`：用上一日百分比（更平滑）；
  - `nan`：标记缺失，由前端/渲染跳过该点。
- 极端小分母：当日总 mentions 很小（如 < 10）时，百分比可信度低。建议在数据中加入 `min_mentions_for_pct` 阈值，低于阈值的百分比可淡化或打上告警注记。
- 归一化残差：由于四舍五入到 1 位产生残差，当前策略“加到最大分量”合理且与顺序稳定性一致，保留该实现。

五、业务呈现与命名统一
- 名称：建议统一为“当月情感占比（%）”与“日级情感占比趋势（%）”。
- 标签：显示 `Positive / Neutral / Negative`，与 JSON 顺序一致。
- 辅助数卡：在页角或图旁展示 `NSS`、`P/N Ratio`、`engagement_total_month`、`ipm_month`，提升解读效率。

六、实施要点（对现有代码/配置的轻量补充）
- 在 `charts/p13/make_data.py` 生成 JSON 时，加入：
  - 类别图与趋势图共同附带 `metrics`（已实现）：`{"engagement_total_month", "ipm_month", "by_day"}`；
  - 新增 `derived` 字段（建议）：在写入前计算 `nss`, `pn_ratio`，例如：
    - `nss = positive_pct - negative_pct`
    - `pn_ratio = (p + 1.0) / (ng + 1.0)`
- 在 `config.yaml` 增加可选项：
  - `fill_policy.missing_day: zeros|previous|nan`
  - `fill_policy.axis_day_base`（已支持）
  - `charts.p13.show_ma7: true|false`（控制均线输出）

七、校验清单（落地时逐项核对）
- slide13 是否仅引用 chart10 与 chart11，且类型分别为类别图与散点/线图。
- `brand_key` 是否小写匹配，`countryId` 与日期窗口是否来自 `config.yaml`。
- 月度/日级查询是否分别落在 `brand_metrics_month` 与 `brand_metrics_day`。
- 百分比是否保留 1 位且合计 100.0（允许 ±0.1 的残差前后处理）。
- 缺失日是否按选定策略填充，并对极小分母做弱化或提示。
- 指标数卡：`NSS / P/N Ratio / engagement_total_month / ipm_month` 是否展示、与数据一致。

结论：
- 现有 readme 对“图表类型、数据来源、百分比口径、x 轴映射与回退机制”的理解基本正确；本纠正主要补充“指标解释与展现”、明确“归一化残差”、完善“缺失数据策略”，并建议引入 `NSS / P/N Ratio / MA7` 等辅助指标，以增强业务解读与稳定性。