# P13 需求说明（Engagement breakdown – France）

本文档明确 P13 页的需求、数据来源、指标定义、Excel 输出格式、PPT 填充策略与构建流程。页面级实现严格遵循“模板不改动、页面级 tmp、可人工校验与修改”的原则。

## 1. 目标与范围
- 目标：以当前页目录下的 `p13.pptx` 为模板，生成面向法国市场的 Engagement breakdown 页面，输出到本页目录的 `p13-final.pptx`。
- 模板不可被程序修改；生成流程将模板解压到页面级 `tmp`，替换嵌入工作簿与更新图表缓存，再重新打包。
- 生成过程分两步：
  1) `generate_excel.py` 计算目标数据并写出 Excel，便于人工校验/修改。
  2) `fill_from_excel.py` 用该 Excel 数据填充模板图表并嵌入工作簿，确保 PPT 编辑器内可直接编辑数据表。

## 2. 数据来源与过滤
- 已知数据文件（不直接用程序打开体量大的 DB，可用查询命令或轻量脚本）：
  - `/Users/jinghai/coder/gen_ppt/input/metrics-v4-08.db`
  - `/Users/jinghai/coder/gen_ppt/input/metrics-schemas.md`
  - `/Users/jinghai/coder/gen_ppt/input/neticle-schemas.md`
  - `/Users/jinghai/coder/gen_ppt/input/neticle-v4-08.sqlite`（尽量使用 wide 表）
- 过滤条件：
  - 市场/国家：France（法国；按 `country='FR'` 或 `market='France'` 字段过滤）。
  - 品牌/产品线：Lenovo（与模板保持一致，若需扩展，用页面级配置映射）。
  - 时间范围：以模板陈述为准，默认指向 2025-08（如 `2025-08-01` ~ `2025-08-31`）。页面级配置可调整。
- 数据表优先：Neticle `wide` 表（整合指标列更齐全，便于映射与聚合）。

## 3. 指标与缺失项定义
- 情感分类（Sentiment）：三类 `Positive/Negative/Neutral`，来源于 Neticle 的情感标签。如缺失时：
  - 设定阈值：`sentiment_score > 0.2` 记 Positive，`sentiment_score < -0.2` 记 Negative，其余记 Neutral（阈值可在页面配置调整）。
- Engagement（参与度）统一口径：
  - 总互动量 `engagement_total = sumLikes + sumShares + sumComments`（基于 Neticle 宽表字段）。
  - 缺失字段视为 0；仅对存在的候选字段求和（候选见配置 `engagement.fields_candidates`）。
- 汇总口径（去除曝光/IPM；折线改为指数）：
  - 饼图（Pie）：当月按“参与度权重”的情感占比，公式为 `sentiment_engagement / total_engagement * 100`（保留两位小数）。
  - 折线图（Line/Scatter）：IndexGlobal 趋势指数（三线）。令 `M = max_{d,l}(engagement(l, d))`，则 `Index(lbl, day) = 100 * engagement(lbl, day) / M`；保留两位小数；若 `M = 0` 则统一记 `0.00`；同一日三线不再相加为 100。

## 4. Excel 输出格式（便于人工校验与修改）
`generate_excel.py` 生成本页目录下的 `p13_data.xlsx`，包含：
- Sheet `MetaData`：
  - `Country`（France）、`Brand`（Lenovo）、`Period`（如 `2025-08`）、`TotalEngagement`（当月总参与度）。
- Sheet `PieData`：列结构：
  - `Sentiment`（Positive/Neutral/Negative）
  - `Percentage`（当月情感参与度占比的百分数，保留两位小数）
- Sheet `LineData`：列结构：
  - `Date`（YYYY-MM-DD）
  - `Positive` / `Neutral` / `Negative`（IndexGlobal 趋势指数，保留两位小数；缺失日补 0）
- 以上三张表允许人工直接编辑；`fill_from_excel.py` 将以它们为唯一数据源更新 PPT。

- Sheet `AuditDay`（审计-日汇总）：
  - `Date, PositiveEng, NeutralEng, NegativeEng, TotalEng, Positive%, Neutral%, Negative%`（每日参与度原值与当日百分比，便于核对指数来源；指数不再是当日占比）。
- Sheet `AuditRow`（审计-示例行）：
  - 前 200 行示例，列：`Date, Polarity, Sentiment, PostId, Channel, <候选互动列...>, RowEngagement`（行级参与度与情绪判定，便于核对原始宽表行）。
  - PostId 自动匹配列：`postId/post_id/mentionId/id/postID`；Channel 自动匹配列：`channel/source/platform/network/site`（存在才输出）。
- Sheet `AuditMonth`（审计-月汇总）：
  - `Sentiment, Engagement, Percentage`（当月各情绪参与度及百分比，便于核对 PieData）。

- 颜色映射（与模板一致）：
  - Positive：`#009FA9`
  - Neutral：`#FFBC42`
  - Negative：`#D81159`
- 系列顺序：固定为 `Positive → Negative → Neutral`，与模板图例顺序保持一致；可在 Excel 中通过行顺序明确，但脚本仍以上述优先级稳定排序。
- 脚本将同时更新 `chart1.xml`（饼图）与 `chart2.xml`（折线/散点图）中的数据缓存和系列颜色，确保 PPT 打开后图例顺序与颜色稳定。

## 6. PPT 填充与嵌入策略
- 模板：`/Users/jinghai/coder/gen_ppt/charts/p13/p13.pptx`。
- 页面级临时目录：`/Users/jinghai/coder/gen_ppt/charts/p13/tmp`（自动创建与清理）。
- 嵌入工作簿：创建/替换 `ppt/embeddings/Microsoft_Excel_Worksheet1.xlsx`（名称可在页面配置中设定）。
- 图表缓存更新：
  - 饼图：更新 `c:ser` 下的 `c:pt`/`c:numCache` 与 `c:tx`，并同步颜色到 `c:spPr/c:solidFill`。
  - 折线/散点：按情感三线更新 `c:ser` 的 `c:xVal`/`c:yVal` 缓存与颜色，确保空日补 0。
- 内容类型与关系文件：
  - 在 `[Content_Types].xml` 增加嵌入 `xlsx` 覆盖项。
  - 在 `ppt/charts/_rels/chart*.xml.rels` 指向该嵌入工作簿。
- 模板文件本体不做任何程序性修改；所有更改发生在解压后的临时副本或最终打包产物中。

## 7. 构建流程与入口
- 执行步骤：
  1) 在本页目录运行 `generate_excel.py`，生成 `p13_data.xlsx`（便于人工校验/修订）。
  2) 运行 `fill_from_excel.py`，用 Excel 填充并嵌入更新模板，生成 `p13-final.pptx`。
- 页面级代码只引用页面级配置文件 `charts/p13/config.yaml`；必要的全局配置已拷贝到页面级配置并在此维护。

## 8. 缓存与生效问题处理
- 统一通过更新 `chart10.xml`、`chart11.xml` 的数据缓存，使 PPT 打开即展示新数据。
- 同时嵌入 `Microsoft_Excel_Worksheet1.xlsx`，保证编辑器中“编辑数据”可直接看到同源表。
- 若模板中存在旧的 `xlsb`，在最终打包时不包含旧 `xlsb`，仅保留新的 `xlsx`。

## 9. 配置项（页面级 `config.yaml` 摘要）
- `project`: 页面信息与输出路径、模板路径。
- `data_sources`: 已知 DB 及表名，优先 `neticle wide`。
- `time_range`: `start_date`/`end_date`，默认指向 2025-08。
- `filters`: `country='FR'`、`brand='Lenovo'`、渠道/语言等可选过滤。
- `sentiment`: 标签与判定阈值；颜色映射。
- `charts`: 饼图与折线图的数据列映射、权重配置。
- `engagement`: 参与度字段列表与权重；是否使用聚合列。
- `output`: Excel 与最终 PPT 输出文件名。
- `fill_policy`: 嵌入工作簿名、系列顺序、颜色优先级等。

## 10. 验证与人工检查
- 人工首先核对 `output/p13_data.xlsx`：
  - `PieData` 百分比是否总计约 100%；情感比例是否符合预期；颜色是否可读。
  - `LineData` 每日数值与峰值日期是否合理；空日是否 0。
  - `MetaData` 的国家、时间与权重/指标配置是否正确。
- 打开 `output/p13-final.pptx`：
  - 双击图表，检查数据源表是否可编辑；图例顺序与颜色是否符合设定；
  - 文本、标签等模板修改是否原样保留（模板内容不被程序改动）。

## 11. 成功判定
- 生成的 PPT 保留模板所有文字与标注；
- 图表数据与嵌入表一致，编辑器可直接编辑；
- 法国过滤与时间范围正确，颜色与顺序稳定；
- 构建入口一键完成，输出位于页面级 `output` 目录；
- 无跨页/跨目录的临时文件泄漏。