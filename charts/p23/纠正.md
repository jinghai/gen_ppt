# P23 纠正说明（图表类型分布、口径与实现一致性）

- 结论速览
  - 本页共 16 个图表：chart39.xml ~ chart54.xml（见 config.yaml）。
  - 实际类型分布：
    - chart39.xml → doughnutChart（环形图，7 品牌 SOV）。
    - 其余 15 个（chart40.xml~chart54.xml）→ lineChart（折线图，Lenovo vs Others 日级趋势）。
  - readme 目前描述为“15 个 SOV + 1 个趋势”不准确；应改为“1 个 SOV（环形）+ 15 个趋势（折线）”。

- 证据与定位
  - slide23 关系：ppt/slides/_rels/slide23.xml.rels 指向 chart39.xml ~ chart54.xml，并包含多张图片引用（背景/装饰）。
  - 类型判定（示例）：
    - charts/p23/chart39/original_meta.json → `"chart_type": "doughnutChart"`
    - charts/p23/chart40/original_meta.json → `"chart_type": "lineChart"`
    - charts/p23/chart41/original_meta.json → `"chart_type": "lineChart"`
    - ...
    - charts/p23/chart54/original_meta.json → `"chart_type": "lineChart"`
  - 配置：charts/p23/config.yaml 的 `replace_charts` 包含上述 16 个 chartXX.xml；`final_mode: updated`，`axis_day_base: 20300`（用于趋势 x 轴映射）。
  - 实现：charts/p23/make_data.py 中 `lineChart/scatterChart → make_trend_lenovo_vs_others`；`bar/pie/area/doughnut → make_sov`。

- 正确的数据源与口径
  - SOV（chart39，环形图）
    - 表：`brand_metrics_month`；月份取 `compute_metrics.yaml.time_range.start_date` 所在月。
    - 分子：各品牌 `brand_mentions` 汇总；分母：各 `(countryId, month)` 的 `total_mentions` 最大值求和；SOV=round(...,1)。
    - 与 p21/p22 一致，可复用其 SQL 参考。
  - 趋势（chart40~54，折线图）
    - 表：`brand_metrics_day`；日期范围由 `compute_metrics.yaml.time_range` 给出（闭区间）。
    - 品牌集合：`cfg.brands_order`；基准品牌：若包含 `lenovo` 则为 `lenovo`，否则取第一个。
    - 口径：
      - y：每日 `base_brand` 的 brand_mentions 与 “Others”（其余所选品牌 brand_mentions 之和）。
      - x：按自然日生成序列，映射为 `axis_day_base + 序号(从1起)`。
    - 生成结果结构（写入 data.json/final_data.json）：
      ```json
      {
        "scatter_series": [
          {"name": "Lenovo", "x": [...], "y": [...], "points": [[x,y], ...]},
          {"name": "Others",  "x": [...], "y": [...], "points": [[x,y], ...]}
        ]
      }
      ```
    - SQL 参考（每日聚合后在代码内二次整形）：
      ```sql
      SELECT day, brand, SUM(brand_mentions) AS brand_mentions
      FROM brand_metrics_day
      WHERE day >= ? AND day <= ?
        AND brand IN (?, ?, ?, ?, ?, ?, ?)
      GROUP BY day, brand
      ORDER BY day ASC;
      ```

- 文档修订建议（readme）
  - 更正图表类型与分布：
    - “1 个 SOV（doughnutChart，chart39）+ 15 个趋势（lineChart，chart40~54）”。
  - 在“高密度图表处理/性能优化”章节保留当前实现的批量处理逻辑描述，并明确：
    - 15 张折线图均使用 “Lenovo vs Others” 两序列数据（当前实现一致填充）。
    - 若未来需要“Lenovo vs 单个品牌”的多变体，请在 `make_data.py` 中按 chart 目录名扩展差异化数据生成逻辑。
  - 保留 `axis_day_base` 的解释，并说明其用于折线 x 轴日期映射。

- 实施核对清单（本页应满足）
  - [x] chart39 类型为 `doughnutChart`，其余 15 个为 `lineChart`。
  - [x] `make_sov` 只用于 chart39；`make_trend_lenovo_vs_others` 用于 chart40~54。
  - [x] 生成的折线数据包含两条序列：`Lenovo` 与 `Others`。
  - [x] config.yaml 覆盖 16 个 chartXX.xml；构建 `python build.py` 后图表替换成功。

- 可选增强（非必须）
  - 为趋势增加 7 日移动平均或同比/环比序列，提升可读性（新增序列并行展示）。
  - 若要将 15 张折线图做“分品牌对比”，可在各 chart 目录放置 `brand.txt` 指定对比目标，并在 `make_data.py` 为每个 chart 读取该约定生成差异化数据。