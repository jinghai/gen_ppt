# P17 纠正说明（单图，lineChart 趋势）

一、模板与实际核对
- slide17.xml.rels 仅引用 1 个图表：chart24.xml，以及一张图片；无其它图表。
- chart24/original_meta.json 标注 chart_type = lineChart，模板是折线/散点类趋势图。
- 现有 readme 将本页描述为“类别图 + 趋势图”的混合形态，不符合模板；本页应为“单张日级趋势图（Brand vs Others）”。

二、当前实现问题
- 趋势计算未按国家过滤：make_trend_lenovo_vs_others 只按 day 与 brand 过滤；countryId 未过滤，存在跨国家数据混入风险。
- SOV 描述与实现：本页仅有 lineChart，无需生成 SOV 类别数据；readme 中的 SOV 配置应从本页移除。

三、建议口径（单图 Lenovo vs Others）
- 两条序列：
  - Lenovo（或配置的 base_brand）日级 brand_mentions
  - Others = 所选品牌集合除 base_brand 之外的合计
- X 轴：按 `axis_day_base + 序号` 映射为浮点，保持与模板一致。

四、数据过滤与计算规范
- 过滤维度：`countryId = :countryId`（新增配置），`day BETWEEN :start_date AND :end_date`，`brand IN :brands`。
- 缺失填充：某日缺值→0，保持时间轴连续。
- 品牌大小写：内部统一小写比对，输出时按展示名（例如首字母大写）。

五、SQL/实现要点（SQLite）
- SQL（按国家与品牌集合取日级）：
  ```sql
  SELECT day, brand, SUM(COALESCE(brand_mentions,0)) AS bm
  FROM brand_metrics_day
  WHERE day BETWEEN :start_date AND :end_date
    AND countryId = :countryId
    AND brand IN (:b1,:b2,:b3,:b4,:b5,:b6,:b7)
  GROUP BY day, brand;
  ```
- Python：
  - `make_trend_lenovo_vs_others(cfg, conn)` 增加 countryId 过滤；
  - base_brand 默认 'lenovo'（若存在），否则 brands[0]；
  - days = 全量日期列表；
  - `y_base[d] = bm(day, base_brand)`，`y_others[d] = Σ_bm(day, brand≠base_brand)`；
  - `x = axis_day_base + 1..N`；
  - 输出为 scatter_series，含 `x/y/points`。

六、readme 调整建议
- 移除 SOV 类别图描述；保留“Lenovo vs Others 日级趋势（lineChart）”。
- 明确：本页仅 1 张图（chart24.xml），不涉及多图品牌映射。

七、校验清单
- 模板：chart24.xml 为 lineChart（已核验）。
- 口径：单国家、所选品牌集合、日级完整、缺失补 0。
- 输出：scatter_series 两条线；x 单调递增、长度与 days 一致。

结论：
- P17 为“单图日级趋势”页面，应删除 SOV 类别图描述；实现侧需补充国家过滤，确保 Lenovo vs Others 的时间序列在模板中正确显示。