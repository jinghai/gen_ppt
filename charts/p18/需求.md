# P18 需求说明（法国市场）

## 目标
- 基于数据库宽表 `mentions_wide` 生成法国市场 P18 页面数据，并以 `charts/p18/p18.pptx` 为模板生成可编辑的单页 PPT：`charts/p18/output/p18-final.pptx`。
- 提供一份可检验的汇总 Excel（`charts/p18/p18_data.xlsx`）与 4 份嵌入用 xlsx，保证 PPT 图表在编辑器内可直接查看与修改，且数据来源透明。

## 数据来源与配置
- 主库：`input/neticle-v4-08.sqlite`（表：`mentions_wide`）
- 配置文件：`charts/p18/config.yaml`
  - `data_sources.neticle_db`、`data_sources.neticle_table`、`data_sources.date_column`、`data_sources.country_column`
  - `filters.country_id`、`filters.country_name`、`filters.brand_key`、`filters.keyword_like`
  - `sentiment.thresholds.column`、`sentiment.thresholds.positive_min`、`sentiment.thresholds.negative_max`
  - `months.main`、`months.split`、`months.auto_discover`
  - `ranking.brands`

## 页面结构（模板对应）
- 主趋势折线图：Net Lovers Trend（6 点，按月份）
- Ranking 文本：与主趋势同月顺序，显示 `#排名`
- Sentiment Split：LOVERS（绿）、NEUTRAL（黄）、HATERS（红）（各 4 点，按月份）

## 指标与计算
- Lovers%：`positive_count / total_count × 100`，正向条件 `polarity > 0.33`
- Neutral%：`neutral_count / total_count × 100`，条件 `-0.33 <= polarity <= 0.33`
- Haters%：`negative_count / total_count × 100`，条件 `polarity < -0.33`
- Net Lovers%：`Lovers% - Haters%`
- 排名：当月多品牌 Net Lovers% 排序，取 Lenovo 的名次（`ranking.brands` 可配置）

## 严格过滤与匹配规则
- 品牌识别：仅使用 `keyword_label` 做匹配（不回退其他列）
  - Lenovo：`LOWER(keyword_label) LIKE LOWER(:keyword_like)`（来自配置）
  - 其他品牌：`LOWER(keyword_label) LIKE LOWER('%{brand.lower()}%')`
- 国家过滤：`countryId = :country`（来自配置）
- 日期匹配：支持文本日期与 epoch(ms)，统一按月聚合
- 字段校验：若 `keyword_label` 或 `countryId` 缺失，立即抛错（不兜底）

## 错误处理与数据来源标注
- 数据库连接或查询失败：立即抛错，不静默处理
- 模板数据提取失败（嵌入 xlsx、chartXML 均不可用）：直接报错，不使用默认值
- 计算覆盖策略：
  - 以模板数据为基线，能计算到的月份用数据库结果覆盖；无计算的月份保留模板值，并在 Excel `Source` 行显式标注为 `template`（非兜底掩盖）
  - 若所有输出均为模板值（没有任何 `computed`），直接抛错，提示检查品牌匹配与月份配置

## 生成文件与目录
- 汇总数据：`charts/p18/p18_data.xlsx`
  - `MainTrend`：行1 `Month`（6列），行2 `NetLovers%`（6列，整数），行3 `Source`（6列，`template|computed`）
  - `Ranking`：行1 `Month`（6列），行2 `Position`（6列，整数），行3 `Source`（6列）
  - `Lovers` / `Neutral` / `Haters`：各自行1 `Month`（4列），行2 值（4列，整数），行3 `Source`（4列）
- 页面级嵌入工作簿（供 PPT 图表指向）：
  - `tmp/ppt/ppt/embeddings/Microsoft_Office_Excel_Binary_Worksheet1.xlsx`（主趋势 A1:F1）
  - `tmp/ppt/ppt/embeddings/Microsoft_Office_Excel_Binary_Worksheet2.xlsx`（Lovers A1:D1）
  - `tmp/ppt/ppt/embeddings/Microsoft_Office_Excel_Binary_Worksheet3.xlsx`（Neutral A1:D1）
  - `tmp/ppt/ppt/embeddings/Microsoft_Office_Excel_Binary_Worksheet4.xlsx`（Haters A1:D1）
- 页面级图表 XML（填充后可覆盖模板的 numCache）：
  - `tmp/ppt/ppt/charts/chart1.xml .. chart4.xml` 与 `_rels/chartX.xml.rels`
- 最终输出：`charts/p18/output/p18-final.pptx`

## 构建与填充流程（按代码实现）
1) `generate_excel.py`：
   - 解压模板到 `tmp/ppt`；优先读取嵌入 xlsx，失败则回退解析 chartXML；若任一系列数据为空，抛错
   - 连接数据库，按严格过滤计算：正/中/负/总计，计算百分比与 Net Lovers%，以及 Lenovo 排名
   - 用计算结果覆盖模板基线；写出 `p18_data.xlsx` 与 4 个嵌入 xlsx（Sheet1 首行仅数值）；在 Excel 中记录 `Source`
   - 校验：若无任何 `computed` 覆盖，抛错
2) `fill_from_excel.py`：
   - 从 `charts/p18/p18_data.xlsx` 读取各表数据，更新 `chart1..4.xml` 的 `numCache`
   - 修正 `externalData/autoUpdate=1`；写 `_rels` 指向页面嵌入 xlsx；更新 slide1 文本与内容类型
   - 兼容解压结构：`tmp/ppt/ppt` 与 `tmp/ppt`
3) `build.py`：
   - 仅负责打包（不自动运行 `generate_excel.py`/`fill_from_excel.py`）
   - 读取模板 `presentation.xml(_rels)` 与 `[Content_Types].xml`，保留指定页关系，重定向为 `slide1`
   - 收集页面级嵌入 xlsx（如存在），写入内容类型；根据当前页关系映射 `chart1..4.xml` 到模板页图表名
   - 输出到 `charts/p18/output/p18-final.pptx`；日志写入 `charts/p18/logs/build.log`

## SQL 与参数（示例）
```sql
SELECT 
    COUNT(CASE WHEN polarity > :pos_min THEN 1 END) as positive_count,
    COUNT(CASE WHEN polarity BETWEEN :neg_max AND :pos_min THEN 1 END) as neutral_count,
    COUNT(CASE WHEN polarity < :neg_max THEN 1 END) as negative_count,
    COUNT(*) as total_count
FROM mentions_wide 
WHERE countryId = :country 
  AND LOWER(keyword_label) LIKE LOWER(:keyword_like)
  AND ({date_match_clause})
```
- `:country`：国家ID（法国=39）
- `:keyword_like`：品牌关键词模式（Lenovo 来自配置；其他品牌按名称生成）
- `:pos_min`：正向阈值（默认 0.33）
- `:neg_max`：负向阈值（默认 -0.33）
- `date_match_clause`：日期范围匹配（支持文本与 epoch(ms) 转换）

## 月份自动发现
- 当 `months.auto_discover=true` 时，从库中按严格过滤条件发现月份集合
- 自动发现不足（少于所需 6/4 个）直接报错，不兜底到固定配置
- 发现逻辑兼容多日期列：文本、`unixepoch`、毫秒时间戳

## 目录与依赖管理
- 临时与解压：仅使用页面级 `charts/p18/tmp`；不在根目录随地生成临时文件
- 调试需求：如需新增调试文件，统一放到项目根目录 `tmp/` 下
- 包依赖：`openpyxl`, `pyyaml`；安装命令：`pip install openpyxl pyyaml`

## 一键构建
- 执行：`python charts/p18/build.py`
- 前置：需已运行 `generate_excel.py` 和 `fill_from_excel.py`，准备好 `tmp/ppt` 与 `p18_data.xlsx`；否则打包阶段会报错

## 注意事项
- 禁止使用 HTTP 预览或下载；所有文件本地读写
- 严格模式：必需字段或数据缺失立即报错；不允许兜底掩盖错误
- 模板基线：仅保留为未覆盖月份的显式来源；Excel 中标识为 `template`
- 遵循 MVP：实现聚焦、注释完善，所有变更限制在页面级目录