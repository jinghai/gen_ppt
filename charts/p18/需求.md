# P18 需求说明（法国市场）

## 目标
- 基于现有数据库生成法国市场的 P18 页面数据，并以 `charts/p18/p18.pptx` 为模板生成可编辑的单页 PPT：`charts/p18/output/p18-final.pptx`。
- 数据来源优先使用宽表 `mentions_wide`，生成一份可检验的 Excel 数据文件，并将其作为 PPT 图表的嵌入数据源，保证在 PPT 编辑器内可直接查看和修改。

## 数据来源
- `input/neticle-v4-08.sqlite`（宽表 `mentions_wide`）
- 配置文件：`charts/p18/config.yaml`

## 页面结构（对应模板）
- 主趋势折线图：`Net Lovers Trend`，月份为 2025-03 至 2025-8，共 6 点
- Ranking 行：与主趋势同月顺序，显示 `#排名`
- Sentiment Split：LOVERS（绿）、NEUTRAL（黄）、HATERS（红），月份为 2025-05 至 2025-8，共 4 点/图

## 指标定义与计算公式
### 基础指标
- **Lovers%**：按月在法国（`countryId=39`）的 Lenovo 相关提及中，正向提及占比
  - 计算公式：`正向提及数 / 总提及数 × 100`
  - 正向条件：`polarity > 0.33`
- **Neutral%**：中性提及占比
  - 计算公式：`中性提及数 / 总提及数 × 100`
  - 中性条件：`-0.33 <= polarity <= 0.33`
- **Haters%**：负向提及占比
  - 计算公式：`负向提及数 / 总提及数 × 100`
  - 负向条件：`polarity < -0.33`
- **Net Lovers%**：净正向占比
  - 计算公式：`Lovers% - Haters%`

### 排名计算
- **Ranking**：以当月法国市场各品牌 `Net Lovers%` 由高到低的名次，Lenovo 的名次作为展示值
- 参与排名品牌：`["lenovo","dell","hp","asus","acer","apple","samsung"]`

## 品牌相关提及识别规则（严格模式）使用 config.yaml 中的配置
- 选择 `mentions_wide` 且 `countryId=39`（法国）
- **品牌识别**：严格使用 `keyword_label` 字段进行品牌匹配
  - **Lenovo 匹配逻辑**：`keyword_label LIKE '%lenovo%'`（使用 config.yaml 中的 `filters.keyword_like` 配置）
  - **其他品牌匹配逻辑**：`keyword_label LIKE '%{brand.lower()}%'`
  - **严格要求**：如果 `keyword_label` 字段不存在，立即抛出 `RuntimeError`，不允许任何兜底
- 情感分桶（阈值可调，默认 0.33）：
  - Positive：`polarity > 0.33`
  - Neutral：`-0.33 <= polarity <= 0.33`
  - Negative：`polarity < -0.33`

## 国家过滤规则（严格模式）
- **国家识别**：严格使用 `countryId` 字段进行过滤
- **过滤条件**：`countryId = 39`（法国，使用 config.yaml 中的 `filters.country_id` 配置）
- **严格要求**：如果 `countryId` 字段不存在，立即抛出 `RuntimeError`，不允许任何兜底

## 错误处理策略（无兜底模式）
- **数据库连接失败**：立即抛出异常，不允许静默处理
- **必需字段缺失**：立即抛出 `RuntimeError`，不允许兜底到其他字段
- **查询执行失败**：立即抛出异常，不允许忽略错误
- **模板数据缺失**：允许使用模板中的数值补全缺失月份数据，但必须明确标注 `source=template`
- **数据验证失败**：如果没有任何计算数据（全部为模板数据），抛出异常提示检查配置

## 生成文件与目录
- `charts/p18/p18_data.xlsx`：汇总数据（便于检验与人工修订）
  - `MainTrend`：`Jul..Dec` 的 `NetLovers%`
  - `Ranking`：`Jul..Dec` 的 `#名次`（整数）
  - `Lovers` / `Neutral` / `Haters`：`Sep..Dec` 的对应百分比
- 页面级嵌入工作簿（供 PPT 图表指向）：
  - `tmp/ppt/ppt/embeddings/Microsoft_Office_Excel_Binary_Worksheet1.xlsx`（主趋势 A1:F1）
  - `tmp/ppt/ppt/embeddings/Microsoft_Office_Excel_Binary_Worksheet2.xlsx`（Lovers A1:D1）
  - `tmp/ppt/ppt/embeddings/Microsoft_Office_Excel_Binary_Worksheet3.xlsx`（Neutral A1:D1）
  - `tmp/ppt/ppt/embeddings/Microsoft_Office_Excel_Binary_Worksheet4.xlsx`（Haters A1:D1）
- 页面级图表 XML（可覆盖模板的数据缓存）：
  - `tmp/ppt/ppt/charts/chart1.xml .. chart4.xml` 与 `_rels/chartX.xml.rels`

## 构建与填充流程
1) `generate_excel.py`：
   - **第一步**：解压模板PPT到 `tmp/ppt` 目录，从嵌入的Excel文件中读取模板数据作为基础数据
   - **第二步**：连接数据库，严格按照品牌和国家过滤规则计算最新的情感分析数据，用计算结果替换对应月份的模板数据
   - **第三步**：生成 `p18_data.xlsx` 汇总文件，写入 4 份嵌入 `xlsx`（Sheet1，指定范围），并在汇总表中记录数据来源（`template`/`computed`），保证可检验
   - **验证策略**：如果没有任何计算数据覆盖模板数据，抛出异常提示检查品牌匹配与月份配置
2) `fill_from_excel.py`：
   - 将 `p18_data.xlsx` 中的值更新至页面级 `chart*.xml` 的 `numCache`
   - 纠正 `externalData.autoUpdate=1`
   - 写入 `_rels` 关系，目标指向上述 4 个嵌入 `xlsx`
   - 更新 slide1.xml 中的排名文本和百分比文本
   - 保持颜色与系列顺序不变，保证视觉一致
3) `build.py`：
   - 仅使用页面级 `tmp` 目录打包，保留模板文字样式不变
   - 重定向到单页输出 `output/p18-final.pptx`

## 数据库查询实现
### SQL查询逻辑
```sql
SELECT 
    COUNT(CASE WHEN polarity > :pos_min THEN 1 END) as positive_count,
    COUNT(CASE WHEN polarity BETWEEN :neg_max AND :pos_min THEN 1 END) as neutral_count,
    COUNT(CASE WHEN polarity < :neg_max THEN 1 END) as negative_count,
    COUNT(*) as total_count
FROM mentions_wide 
WHERE countryId = :country 
    AND keyword_label LIKE :keyword_like
    AND ({date_match_clause})
```

### 参数说明
- `:country`: 国家ID（法国=39，来自 config.yaml）
- `:keyword_like`: 品牌关键词模式（Lenovo 使用 config.yaml 中的 `filters.keyword_like`，其他品牌使用 `%{brand}%`）
- `:pos_min`: 正向阈值（默认0.33，来自 config.yaml）
- `:neg_max`: 负向阈值（默认-0.33，来自 config.yaml）
- `date_match_clause`: 日期范围匹配（支持多种日期格式的毫秒时间戳）

## 配置文件结构
`charts/p18/config.yaml` 包含以下配置：
- `data_sources`: 数据库路径、表名、字段映射
- `filters`: 国家ID、关键词匹配模式
- `sentiment.thresholds`: 情感阈值配置
- `months`: 月份定义和自动发现设置
- `ranking.brands`: 参与排名的品牌列表

## 月份自动发现
- 当 `config.yaml` 中 `months.auto_discover=true` 时，系统会自动从数据库中发现可用月份
- 自动发现使用与数据计算相同的严格过滤条件（`keyword_label` + `countryId`）
- 如果自动发现失败，直接抛出异常，不允许兜底到配置月份

## 临时目录与页面级隔离
- 仅在 `charts/p18/tmp` 内进行解压与中间处理；不在根目录生成临时文件
- 页面级代码仅引用页面级配置与模板，不再依赖根级配置

## 一键构建
- 执行顺序：`python charts/p18/build.py`
  - 自动运行 `generate_excel.py` → `fill_from_excel.py` → 打包输出

## Excel 结构详解
- `MainTrend`：行1 `Month`（6列），行2 `NetLovers%`（6列，数值），行3 `Source`（6列，`template|computed`）
- `Ranking`：行1 `Month`（6列），行2 `Position`（6列，整数），行3 `Source`（6列）
- `Lovers`：行1 `Month`（4列），行2 `Lovers%`（4列），行3 `Source`（4列）
- `Neutral`：行1 `Month`（4列），行2 `Neutral%`（4列），行3 `Source`（4列）
- `Haters`：行1 `Month`（4列），行2 `Haters%`（4列），行3 `Source`（4列）

## 注意事项
- 禁止使用 HTTP 预览或下载；所有输出均在本地目录内
- 严格管理依赖，仅使用标准库与 `openpyxl`；若环境缺失将降级提示
- 注释完善，遵循 MVP，避免过度设计；更改集中在页面级目录
- **严格模式**：环境或必需字段缺失应报错，禁止兜底掩盖错误；数据库缺失月份保留模板值并明示来源
- **品牌匹配**：严格限制为 `keyword_label` 字段，不允许兜底到其他字段
- **国家过滤**：严格限制为 `countryId` 字段，不允许兜底到其他字段