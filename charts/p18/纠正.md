# P18 纠正说明（图表类型与数据口径修正）

## 实际情况确认
- slide18 关系文件：`ppt/slides/_rels/slide18.xml.rels` 明确引用 4 个图表：`chart25.xml`、`chart26.xml`、`chart27.xml`、`chart28.xml`，以及一张图片 `image43.png`。
- 各图表原始元信息：
  - `chart25/original_meta.json` → `chart_type: lineChart`
  - `chart26/original_meta.json` → `chart_type: lineChart`
  - `chart27/original_meta.json` → `chart_type: lineChart`
  - `chart28/original_meta.json` → `chart_type: lineChart`

结论：P18 页面共有 4 个图表，且全部为折线图（lineChart）。`readme.md` 中关于“类别图 SOV（饼/柱/面积/环形）+ 趋势图”的描述与事实不符，应予以修正。

## 页面与数据含义（应以“日级趋势”统一）
- 图表数量：4
- 图表类型：全部为折线图（lineChart）
- 统一口径：Lenovo vs Others 的日级趋势（以 `brand_metrics_day` 构造时间序列）。
- X 轴：以 `axis_day_base`（当前为 20300）按天顺延映射；Y 轴为品牌提及数。
- Others 定义：所选品牌集合中除基准品牌（默认 Lenovo）之外的合计值。

当前 `make_data.py` 的实现逻辑（与 P16/P17 一致）：
- 自动识别图表类型：若为 `scatterChart/lineChart`，则调用 `make_trend_lenovo_vs_others` 生成两条序列（基准品牌 vs Others）；否则生成 SOV 类别数据。
- 对于 P18 的 4 个折线图，由于均识别为 `lineChart`，会为每个 `chart25~28` 生成一致口径的“Lenovo vs Others 日级趋势”数据（未做 per-chart 差异化选择）。

## 数据来源与口径细节
- 品牌集合：来自根级 `config.yaml` → `filters.brands`（例如含 `lenovo` 时，基准品牌固定为 `lenovo`；否则取列表首个）。
- 时间窗口：读取 `compute_metrics.yaml.time_range`（默认 `2025-08-01` 至 `2025-08-31`）。
- 数据表与字段：`brand_metrics_day(day, brand, brand_mentions, countryId, …)`。
- 示例 SQL（由代码生成）：
  ```sql
  SELECT countryId, day, brand, brand_mentions
  FROM brand_metrics_day
  WHERE day >= :start_date AND day <= :end_date
    AND brand IN (:brands)
  ```
- X 轴映射：`x[i] = axis_day_base + (i+1)`，保证与模板坐标体系对齐。

## 建议的文档与配置修订
1) 更新 `charts/p18/readme.md`
- 移除“类别图 SOV（饼/柱/面积/环形）”相关描述；明确：P18 为 4 个折线图的日级趋势展示，来源 `brand_metrics_day`。

2) 如需让 4 个图展示不同“基准品牌 vs Others”（避免四图完全一致）
- 推荐增加 per-chart 配置，并调整 `make_data.py` 在遍历 `chart*` 时按图表名选取基准品牌。
- 配置示例（可追加到根级 `config.yaml` 或 `charts/p18/config.yaml`）：
  ```yaml
  p18:
    per_chart_base_brand:
      chart25.xml: lenovo
      chart26.xml: hp
      chart27.xml: dell
      chart28.xml: asus
  ```
- 代码示例（在 `make_data.py` 的遍历中应用）：
  ```python
  page_cfg = (yaml.safe_load((GEN/ 'config.yaml').read_text(encoding='utf-8')) or {}).get('p18', {})
  per_chart = (page_cfg or {}).get('per_chart_base_brand') or {}

  # 遍历 chart25~28 时：
  xml_name = Path(raw).name if raw else f"{chart_dir.name}.xml"
  base_brand_override = per_chart.get(xml_name)
  if base_brand_override:
      series = make_trend_lenovo_vs_others(cfg._replace(brands_order=[base_brand_override] + [b for b in cfg.brands_order if b != base_brand_override]), conn)
  else:
      series = make_trend_lenovo_vs_others(cfg, conn)
  ```
  注意：上例为思路示意，实际实现建议以不破坏现有结构为前提，保持兼容性。

3) 可选的国家过滤
- 若需要限定国家，可在 SQL 处追加 `AND countryId IN (…)`，并通过配置传入国家列表。

## 校验清单
- 模板引用：`slide18.xml.rels` 同时包含 4 个 chart 关系（chart25~28）与 1 张图片 `image43.png`，布局为 `slideLayout4.xml`。
- 类型一致：`original_meta.json` 均为 `lineChart`，与模板一致。
- 数据文件：每个 `chart*/final_data.json` 均应包含 `scatter_series` 两条序列（品牌与 Others）。
- 填充脚本：`chart*/fill.py` 在识别为 `lineChart`/`scatterChart` 时会读取散点序列并写回 XML；与数据结构匹配。
- 构建：`charts/p18/config.yaml` 已列出需替换的 4 个图表（chart25~28），`axis_day_base` 设置为 20300；使用 `build.py` 可生成单页预览。

## 影响与后续
- 本页不涉及 `brand_metrics_month` 的 SOV 计算；如需 SOV 展示应在其它含类别图的页面实现。
- 若不做 per-chart 差异化，四个折线图的数据口径完全相同；如需差异，请按上节所述扩展配置与逻辑。
- 缺失数据时将回落到 `original_*` 缓存，确保 PPT 完整性。

---
构建与预览（示例）：
```bash
cd charts/p18
python make_data.py
python build.py
```