# P24 页面纠正说明（图表类型、数据源与计算方法）

## 结论摘要
- 图表覆盖范围应为 28 个图表：`chart55.xml` 至 `chart82.xml`（含首尾）。
- 所有 28 个图表的类型均为 `lineChart`，用于“Lenovo vs Others”的日级趋势对比。
- 本页不包含 SOV 类别图（bar/pie/area/doughnut），不需要按月度 SOV 生成类别型数据。
- 数据源只需使用 `brand_metrics_day`；无需 `brand_metrics_month`。
- 无需新增指标。“Others”可在现有日级明细上按“非 Lenovo 品牌”的合计计算得到。

## 证据与依据
- 原始类型确认：`charts/p24/chart55~chart82/original_meta.json` 中 `chart_type` 均为 `lineChart`。
- 引用范围确认：`config.yaml.output.replace_charts` 覆盖 `chart55.xml` 至 `chart82.xml` 共 28 个；多个子目录 `chart*/chart_path.txt` 与之对应。
- 数据生成逻辑：`make_data.py` 中，`lineChart/scatterChart` 路径统一调用 `make_trend_lenovo_vs_others` 并写入 `scatter_series` 格式；类别图才会调用 `make_sov`。

## 需要纠正的 readme.md 内容
- 页面概述与图表数量
  - 错误：描述为“28 个图表（chart37.xml 到 chart64.xml）/ 含 27 个 SOV + 1 个趋势”。
  - 纠正：应为“28 个图表（chart55.xml 到 chart82.xml），全部为 Lenovo vs Others 日级趋势折线图”。
- 替换图表列表
  - 错误：列表混入 `chart37.xml`、`chart38.xml`，且缺失 `chart81.xml`、`chart82.xml`。
  - 纠正：替换列表应严格包含 `chart55.xml` 至 `chart82.xml` 全部 28 个，无其它编号。
- 数据源与字段
  - 错误：同时列出 `brand_metrics_month` 与类别图数据规范。
  - 纠正：本页仅使用 `brand_metrics_day`；删除类别图（SOV）相关描述与示例。
- 数据格式
  - 错误：包含类别图 JSON 示例。
  - 纠正：仅保留趋势图所需的 `scatter_series` 结构（见下文“数据格式”）。
- 核心算法实现
  - 错误：同时陈述 `make_sov` 与 `make_trend_lenovo_vs_others`，并强调 SOV 占多数。
  - 纠正：仅保留并强调 `make_trend_lenovo_vs_others` 为本页全部图表的数据生成函数。

## 数据源与时间轴
- 表：`brand_metrics_day(countryId, day, brand, brand_mentions, ...)`
- 品牌集合：来自 `charts/config.yaml.filters.brands`（包含 `lenovo`，其余品牌合并为 Others）。
- 时间范围：来自仓库根的 `compute_metrics.yaml.time_range.start_date/end_date`；代码按自然日生成连续序列。
- 轴映射：`x = axis_day_base + i + 1`，其中 `axis_day_base` 来自本页 `config.yaml.fill_policy.axis_day_base`（当前为 `20300`），`i` 为从 0 递增的日序索引。

## 计算方法（Lenovo vs Others 日级趋势）
- 设 `base_brand = 'lenovo'`（若品牌集中不存在 `lenovo`，则取首个品牌）。
- 对时间范围内每一天 d：
  - `lenovo_y[d] = sum(brand_mentions where brand = base_brand and day = d)`
  - `others_y[d] = sum(brand_mentions where brand != base_brand and day = d)`
- 输出两个序列：`Lenovo` 与 `Others`，共享同一 `x`（日期轴映射值）。

示例 SQL 片段（按代码逻辑等价表达）：
```sql
-- 取时间范围内相关品牌的日级数据
SELECT day, brand, SUM(brand_mentions) AS mentions
FROM brand_metrics_day
WHERE day BETWEEN :start_date AND :end_date
  AND brand IN (:brands...) -- 包含 lenovo 及其余需合并到 Others 的品牌
GROUP BY day, brand;
```

在应用侧按天拆分：
```text
Lenovo(d) = mentions(day=d, brand='lenovo')
Others(d) = Σ mentions(day=d, brand!='lenovo')
X(d) = axis_day_base + day_index(d) + 1
```

## 数据格式（用于折线/散点填充）
```json
{
  "scatter_series": [
    {
      "name": "Lenovo",
      "x": [20301, 20302, ...],
      "y": [1250, 1180, ...],
      "points": [[20301, 1250], [20302, 1180], ...]
    },
    {
      "name": "Others",
      "x": [20301, 20302, ...],
      "y": [3850, 3920, ...],
      "points": [[20301, 3850], [20302, 3920], ...]
    }
  ]
}
```

注意：尽管类型为 `lineChart`，本项目统一使用 `scatter_series` 结构供折线/散点填充脚本消费。

## 是否需要新增指标
- 结论：不需要。
- 理由：`brand_metrics_day` 已包含 `brand_mentions`，`Others` 为现有品牌集合的集合求和，无需落库新字段或创建新表。

## 实施与校验清单
- 图表范围
  - 确认 `charts/p24/config.yaml.output.replace_charts` 完整覆盖 `chart55.xml`–`chart82.xml` 共 28 个。
- 类型与数据
  - 抽查多个 `chart*/original_meta.json`，`chart_type` 均为 `lineChart`。
  - 运行 `python charts/p24/make_data.py`，检查每个 `chart*/final_data.json` 均存在 `scatter_series` 且包含 `Lenovo` 与 `Others` 两条序列；`x` 长度等于时间范围天数。
- 构建填充
  - `python charts/p24/build.py` 或使用页面下的 `chart*/fill.py` 脚本，确认能成功填充，不依赖类别图结构。
- 兜底机制
  - 若无数据，脚本返回空序列，构建阶段会回落到 `original_*`，PPT 不至于空白或报错。

## 建议同步修改 readme.md（示例）
- 页面概述：改为“P24 页面包含 28 个 Lenovo vs Others 日级趋势折线图（chart55.xml–chart82.xml）”。
- 替换图表列表：列出 `chart55.xml`–`chart82.xml`，移除 `chart37.xml`、`chart38.xml`，补充 `chart81.xml`、`chart82.xml`。
- 数据源：保留 `brand_metrics_day`；删除 `brand_metrics_month` 与 SOV 内容。
- 数据格式：仅保留 `scatter_series` 示例；删除类别图示例。
- 算法实现：仅保留 `make_trend_lenovo_vs_others` 的描述与伪代码。

---
以上纠正确保 p24 页描述、实现与 PPT 实际图表类型严格一致，避免将 SOV 类别图的说明误用到本页，从而导致数据结构与填充流程不匹配。