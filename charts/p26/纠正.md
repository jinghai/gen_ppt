# p26 纠正说明（图表类型、范围、指标与计算方法校对）

- 结论：p26 为双图页面，实际仅包含 2 个图表，且类型分别为：
  - chart111.xml → doughnutChart（品牌 SOV 类别图）
  - chart112.xml → lineChart（Lenovo vs Others 日级趋势，按散点序列格式填充）
- 数据源：仅需使用现有的 metrics_v5.db 中两张表：`brand_metrics_month`（SOV）与 `brand_metrics_day`（日级趋势）。不需要新增指标或新表。
- 日期轴：使用 `fill_policy.axis_day_base = 20300` 映射自然日到 X 轴数值。

## 1. 与原始 PPT/实现一致性核对
- 目录核对：charts/p26 仅存在 `chart111/` 与 `chart112/` 两个图表目录，config.yaml 中 `replace_charts` 也仅列出 `chart111.xml, chart112.xml`。
- slide 关系文件：`slides/_rels/slide26.xml.rels` 明确引用 `../charts/chart111.xml` 与 `../charts/chart112.xml`。
- 原始元数据：
  - `charts/p26/chart111/original_meta.json` 显示 `chart_type = "doughnutChart"`。
  - `charts/p26/chart112/original_meta.json` 显示 `chart_type = "lineChart"`。
- 数据生成脚本：`charts/p26/make_data.py` 按图表类型动态选择生成逻辑：
  - doughnutChart → 走 `make_sov`，输出类别图 JSON（labels + series）。
  - lineChart → 走 `make_trend_lenovo_vs_others`，输出 `scatter_series` JSON（与 lineChart 模板兼容）。

结论：readme 的“1 个 SOV + 1 个趋势”的总体表述方向正确，但需要补充/细化：chart111 是 doughnutChart、chart112 是 lineChart，且趋势图按 scatter_series 结构填充。

## 2. 指标与数据源
- SOV（chart111）：
  - 源表：`brand_metrics_month`
  - 维度：`month`（由全局 `compute_metrics.yaml.time_range.start_date` 推导出 YYYY-MM），品牌集合来自全局 `config.yaml.filters.brands`。
- 日级趋势（chart112）：
  - 源表：`brand_metrics_day`
  - 维度：`day`（闭区间 `[start_date, end_date]`），品牌集合同上。
- 不新增任何指标。所有字段均来自 metrics_v5.db 已有宽表聚合结果。

## 3. 计算方法（与 make_data.py 对齐）
- SOV（百分比，保留 1 位）：
  - 月份标签：`month_label = start_date[:7]`
  - 查询：过滤 `brand IN (brands_order)` 且 `month = month_label`
  - 分母（总体提及）：`denom = sum(max(total_mentions) by (countryId, month))`
  - 各品牌分子：按品牌聚合 `brand_mentions` 并按 `brands_order` 重排
  - SOV 计算：`sov_i = round(brand_mentions_i / denom * 100.0, 1)`
  - 输出结构：
    - `labels = [capitalize(brand) for brand in brands_order]`
    - `series = [{"name": null, "values": sov_list}]`
- Lenovo vs Others 日级趋势：
  - 品牌基准：`base_brand = 'lenovo' if 'lenovo' in brands_order else brands_order[0]`
  - 日序列：遍历自然日 `days = [start_date..end_date]`
  - 每日 y 值：
    - `y_base[d] = sum(brand_mentions where day=d and brand=base_brand)`
    - `y_others[d] = sum(brand_mentions where day=d and brand!=base_brand)`
  - X 轴映射：`x[i] = axis_day_base + i + 1`（`axis_day_base` 来自 `charts/p26/config.yaml`，为 20300）
  - 输出结构：
    ```json
    {
      "scatter_series": [
        {"name": "Lenovo", "x": [...], "y": [...], "points": [[x,y], ...]},
        {"name": "Others",  "x": [...], "y": [...], "points": [[x,y], ...]}
      ]
    }
    ```

## 4. 示例 SQL 片段（用于验证）
- 月度 SOV：
  ```sql
  -- month_label 例如 '2025-08'
  SELECT brand, SUM(brand_mentions) AS bsum
  FROM brand_metrics_month
  WHERE month = :month_label AND brand IN (:brands)
  GROUP BY brand;

  -- 分母按 (countryId, month) 取 max(total_mentions) 再求和
  SELECT SUM(t.mx) AS denom
  FROM (
    SELECT countryId, month, MAX(total_mentions) AS mx
    FROM brand_metrics_month
    WHERE month = :month_label AND brand IN (:brands)
    GROUP BY countryId, month
  ) t;
  ```
- 日级趋势：
  ```sql
  -- 区间为 [start_date, end_date]
  SELECT day, brand, SUM(brand_mentions) AS mentions
  FROM brand_metrics_day
  WHERE day BETWEEN :start_date AND :end_date
    AND brand IN (:brands)
  GROUP BY day, brand;
  ```

## 5. 数据输出文件
- `chart111/data.json` 与 `final_data.json`：类别图格式（labels + series）。
- `chart112/data.json` 与 `final_data.json`：`scatter_series`（与 lineChart 模板兼容）。

## 6. 对 readme 的建议修订点
- 明确图表类型：
  - chart111 → doughnutChart（SOV）
  - chart112 → lineChart（趋势，填充为 scatter_series）
- 明确仅用两张表：`brand_metrics_month`（SOV）与 `brand_metrics_day`（趋势），无需新增指标。
- 标注 X 轴映射：`axis_day_base = 20300`，`x = base + 序号(+1)`。
- 对 SOV 分母的处理写清楚：按 `(countryId, month)` 取 `total_mentions` 最大值再求和。

## 7. 实施与验证清单
- 确认 config.yaml：
  - `replace_charts: [chart111.xml, chart112.xml]`
  - `final_mode: updated`
  - `fill_policy.axis_day_base: 20300`
- 运行数据生成：`python charts/p26/make_data.py`
- 校验：`python charts/p26/validate.py` 应全部 OK（类别图长度与散点 y 长度不小于原始）。
- 若需要人工快速比对，可查看 `chart111/preview_original.png` 与 `chart112/original_meta.json` 中的 `chart_type`。

以上校对完成：p26 的 readme 描述需细化图表类型与趋势填充结构；无需新增指标，计算方式与实现一致。