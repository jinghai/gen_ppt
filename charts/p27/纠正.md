# P27 页面纠正说明（Brand Positioning Map ×2，双散点图）

本页并非“品牌SOV + Lenovo vs Others 趋势”的组合页。根据版面文字与模板图表：
- 两个图表均为散点图（scatterChart），主题为“Brand Positioning Map: August '24 vs August '25”。
- 横轴为 Brand Power，纵轴为 Brand Love；每个点代表一个品牌在当月的定位坐标。
- 两张图分别对应不同月份的定位快照（建议：上图为基准年同月，如 2024-08；下图为当前月，如 2025-08）。

因此，现有 readme 与生成逻辑描述的 SOV 饼图、Lenovo vs Others 日趋势均不适用于 P27，应统一改为“月度品牌定位散点”。

## 图表与语义
- chart113.xml：散点图，Brand Positioning（参考：August '24）
- chart114.xml：散点图，Brand Positioning（参考：August '25）

坐标语义：
- X 轴（Brand Power）→ 指标 `brand_power`
- Y 轴（Brand Love） → 指标 `brand_love`
- 点：品牌（建议使用配置的 7 大品牌顺序；不足时取出现的前 7 个）
- 不涉及时间序列映射，不使用 `axis_day_base`

## 数据源与字段
- 库：`metrics_v5.db`
- 表：`brand_metrics_month`
- 关键字段（均已存在，无需新增指标）：
  - `brand`，`countryId`，`month`
  - `brand_power`（X 轴）
  - `brand_love`（Y 轴）

过滤条件（与全局配置保持一致）：
- `countryId = config.country_id`
- `brand IN filters.brands`
- 月份：
  - chart113 使用 `prev_month = add_years(start_date[:7], -1)`（如 2024-08）
  - chart114 使用 `curr_month = start_date[:7]`（如 2025-08）

说明：若项目希望对比“上月 vs 本月”，也可改为 `prev_month = month_add(curr_month,-1)` 与 `curr_month`；此处以设计文字“'24 vs '25”采用同比方案。

## 计算方法
- 对目标月份与品牌集合，直接取 `brand_power`、`brand_love` 的当月值。
- 若同一品牌当月出现多行，取聚合（常见为 1 行，可用 `AVG` 或 `MAX`，保持与指标口径一致）。
- 输出点序与品牌顺序一致（按 `filters.brands`）。
- 数值范围通常在 [0,100]，保留 1 位小数即可；无需归一到 100%。

示例 SQL（单月坐标提取）：
```sql
-- :month = '2025-08' 或 '2024-08'
SELECT brand,
       AVG(COALESCE(brand_power, 0.0)) AS x_power,
       AVG(COALESCE(brand_love,  0.0)) AS y_love
FROM brand_metrics_month
WHERE countryId = :countryId
  AND month     = :month
  AND LOWER(brand) IN (:brands_lower_csv)
GROUP BY brand
ORDER BY brand;
```
注：绑定参数 `:brands_lower_csv` 用调用端展开成 `?,?,?...`，并在传参时 `LOWER(brand)`。

## 数据格式与输出
两张散点图的数据结构一致，写入各自的 `chart113/` 与 `chart114/`：
- `data.json` 与 `final_data.json` 均采用：
```json
{
  "scatter_series": [
    {
      "name": null,
      "x": [x1, x2, x3, x4, x5, x6, x7],
      "y": [y1, y2, y3, y4, y5, y6, y7],
      "points": [[x1,y1],[x2,y2],...[x7,y7]]
    }
  ]
}
```
- `name` 可为 `null`（与模板一致）；如需按点显示品牌名，请在后续文本层处理，不影响填充。
- `validate.py` 会校验 `y` 长度不小于模板（本页模板每图 7 个点）。

生成建议（替换当前 `make_data.py` 逻辑）：
- 新增函数 `make_brand_positioning(month_label)`：
  - 输入：`month_label`（如 `2024-08`），品牌列表，`countryId`。
  - 查询 `brand_metrics_month` 的 `brand_power`、`brand_love`。
  - 组装 `scatter_series[0]` 的 `x/y/points` 数组并返回。
- 在 `main()` 中：
  - 对 chart113 调用 `make_brand_positioning(prev_month)` 并写入 `chart113/data.json, final_data.json`。
  - 对 chart114 调用 `make_brand_positioning(curr_month)` 并写入相应目录。
  - 移除对 `axis_day_base` 的依赖；不再调用 `make_trend_lenovo_vs_others`。

## 回退与健壮性
- 若数据库为空或查询不到该月某品牌：
  - 用 0 填充相应 x/y；或从 `original_scatter.json` 回退该点值（推荐后者保持视觉稳定）。
- 若品牌集合少于模板点数：
  - 仍产出至少与模板相同数量的点（可用原始点补齐）。

## 与当前 readme 的差异点（需修正）
- 当前描述为“品牌 SOV + Lenovo vs Others 趋势”，不符合本页实际；应改为“双散点：Brand Power × Brand Love 的月度定位”。
- 数据源仍来自 `metrics_v5.db`，但使用字段为 `brand_power`、`brand_love`，不再使用 `brand_mentions/total_mentions` 与日级 `brand_metrics_day`。
- `axis_day_base` 对本页无意义；无需参与计算。

## 校验与交付检查
- 打开 `charts/p27/validate.py`：
  - `validate_original_vs_template` 应能通过（点数与结构一致）。
  - `validate_counts` 中 `final_data.json` 的 `y` 长度应 ≥ 模板（7）。
- 视觉检查：两图坐标轴标题为“Brand Power / Brand Love”，品牌点位分布合理；年份或月份标签与所取月份一致。

---
结论：本页无需新增指标，直接使用已存在的 `brand_power` 与 `brand_love` 两项即可完成双散点定位图的数据生成与填充；请相应修正 readme 与生成脚本逻辑。