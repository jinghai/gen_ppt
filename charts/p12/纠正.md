# P12 纠正说明（图表理解、指标与计算方法）

## 1) 页面与图表现状修正
- 事实核验：`input/LRTBH-unzip/ppt/slides/_rels/slide12.xml.rels` 仅包含两条 image 关系（`../media/image42.png`、`../media/image45.png`），没有任何 `ppt/charts/chart*.xml` 的关系引用。
- 结论：P12 当前不是数据驱动页面，不包含可替换/可填充的图表；页面由静态图片构成。
- 与现有 README 冲突点：README 声称“7 品牌 SOV”和“Lenovo vs Others 日级趋势”，与模板实际不符，应删除或改为“可选的数据化改造方案（见下）”。

## 2) 建议的数据化改造方案（若要将 P12 从图片改为图表）
- 目标：将两张图片分别替换为两个图表，以实现与 README 设想一致的“品牌 SOV + 日级趋势”。
- 方案概览：
  1. 在 PPT 模板中为 P12 插入两个真实图表（推荐一个类别图 + 一个折线/散点图），保存为新模板并解压到 `input/LRTBH-unzip/`；
  2. 记录两个新图表在模板中的实际文件名（如 `chart80.xml`, `chart81.xml` 等）；
  3. 在 `charts/p12/` 下创建对应的 `chartXX/`、`chartYY/` 目录（每个图表一个目录），并在各目录中放置 `chart_path.txt` 指向对应的 `ppt/charts/chartXX.xml`；
  4.（可选）在 `charts/p12/config.yaml` 中设置 `output.replace_charts: [chartXX.xml, chartYY.xml]`；
  5. 运行 `python charts/p12/build.py` 生成单页输出；必要时先运行 `python charts/p12/make_data.py` 产出 JSON 数据；
  6. 使用 `charts/p12/validate.py` 校验原始模板与解析一致性、数据量与轴映射是否匹配。

> 说明：当前 `charts/p12/make_data.py` 已内置“按图表类型自动生成数据”的逻辑：
> - 若图表类型为 `scatterChart/lineChart`，调用“Lenovo vs Others 日级趋势”生成；
> - 若为 `barChart/pieChart/areaChart/doughnutChart`，调用“7 品牌 SOV”生成；
> 仅当目录下存在 `chart*/` 且 `chart_path.txt` 指向模板图表 XML 时才会真正产出 `data.json/final_data.json` 并在填充阶段生效。

## 3) 指标定义与计算方法（用于数据化改造）
- 数据源：`gen_ppt/config.yaml -> data_sources.metrics_db`（当前示例为 `./input/metrics_v5-08.db`），结构见 `input/metrics_v5-08.db.schemas.md`。
- 过滤口径：
  - `filters.countryId`（当前示例 39=France）；
  - `filters.brands`（统一小写，与 mentions/metrics 中 brand 对齐）；
  - 时间窗口：`update.start_date` ~ `update.end_date`（示例 2025-08-01 ~ 2025-08-31）。
- 品牌映射与显示名：`filters.brands` 与 `filters.brands_display` 一一对应，用于 SOV 标签顺序与展示名称。

### 3.1 品牌 SOV（当月/时间窗口聚合）
- 指标：`brand_mentions`，按品牌聚合；
- 分母：窗口内全部候选品牌的 `brand_mentions` 之和；
- 公式：`SOV(brand) = brand_mentions(brand) / sum_all_brands(brand_mentions) * 100`；
- 保留位数：建议保留 1 位小数，并对各品牌占比做“合计归一到 100.0%”校正（按四舍五入误差自动调节最后一项）。

### 3.2 日级趋势（Lenovo vs Others）
- `base_brand`：来自 `filters.brand_key`（示例 `Lenovo`），内部按小写对齐到 `brand` 字段；
- 对每个自然日 t：
  - `lenovo_t = brand_mentions where brand=Lenovo on date=t`；
  - `others_t = sum(brand_mentions where brand in filters.brands and brand!=Lenovo on date=t)`；
- 输出序列：两条 series（Lenovo、Others），x 轴数值映射为 `x[i] = axis_day_base + i + 1`（`axis_day_base` 默认为 20300，可在 `charts/p12/config.yaml` 的 `fill_policy.axis_day_base` 覆盖）。

### 3.3 可选新增指标（用于增强洞察）
- `SOV_wider`：若库中存在 wider 定义（更广泛声量），可并行计算并与 SOV 对比；
- `share_gap`：`SOV(Lenovo) - max(SOV(others_brands))`，衡量与头部对手差距；
- `MoM/DoD`：对 `brand_mentions` 或 `SOV` 做同比/环比；
- 平滑线：对日级系列添加 7 天滑动均值以降低波动（只做展示，不改变原始值）。

## 4) 数据处理与边界情况
- 缺失数据：
  - 若窗口内某日无记录，补零并保留该日的 `x`；
  - 若分母为 0（当日/当月无任何品牌 mentions），则该日/该月占比定义为 0，并在图例/注释中提示“无数据”。
- 品牌集合不一致：
  - `Others` 仅聚合在 filters.brands 中且排除 `Lenovo` 的品牌；若需更宽集合，需同步扩大 `filters.brands`；
- 小数与归一：
  - SOV 与百分比类指标统一保留 1 位小数，并对合计做归一校正；
- 轴对齐：
  - `axis_day_base` 必须与模板坐标轴一致，否则 `validate.py` 会提示 x/y 长度或数值不匹配。

## 5) 生成与落地步骤（改造后）
1. 在 PPT 模板为 P12 放置两个真实图表并保存；
2. 解压到 `input/LRTBH-unzip/`，记录两个图表的实际 `chart*.xml` 名称；
3. 在 `charts/p12/` 下分别新增 `chartXX/`、`chartYY/` 目录，并在各目录写入 `chart_path.txt`，内容为对应 `ppt/charts/chartXX.xml` 的相对路径或文件名；
4.（可选）在 `charts/p12/config.yaml` 的 `output.replace_charts` 中填入这两个 xml 名称；
5. 运行：
   - `python charts/p12/make_data.py`（生成 `data.json/final_data.json`）
   - `python charts/p12/build.py`（输出单页 PPTX 到 `output/p12.pptx`）
6. 校验：`python charts/p12/validate.py`，检查“原始与模板一致性”和“数据量校验”。

## 6) 示例 SQL（基于 metrics_v5-08.db）
- 月度 SOV（窗口内按整月聚合，实际可用 `update.start_date/end_date` 精确筛选）：
```sql
-- 7 品牌 SOV：窗口内 brand_mentions 聚合
WITH win AS (
  SELECT DATE(?) AS start_dt, DATE(?) AS end_dt
)
SELECT
  LOWER(b.brand) AS brand,
  SUM(b.brand_mentions) AS brand_mentions
FROM brand_metrics_day b, win
WHERE b.date BETWEEN (SELECT start_dt FROM win) AND (SELECT end_dt FROM win)
  AND b.countryId = ?           -- 例如 39（France）
  AND LOWER(b.brand) IN (?,?,?,?,?,?,?)  -- 与 filters.brands 对齐（小写）
GROUP BY LOWER(b.brand)
ORDER BY 1;
```
- 日级趋势（Lenovo vs Others）：
```sql
WITH win AS (
  SELECT DATE(?) AS start_dt, DATE(?) AS end_dt
), daily AS (
  SELECT
    date,
    LOWER(brand) AS brand,
    SUM(brand_mentions) AS mentions
  FROM brand_metrics_day b, win
  WHERE b.date BETWEEN (SELECT start_dt FROM win) AND (SELECT end_dt FROM win)
    AND b.countryId = ?
    AND LOWER(b.brand) IN (?,?,?,?,?,?,?)
  GROUP BY date, LOWER(brand)
), lenovo AS (
  SELECT date, SUM(mentions) AS lenovo_mentions
  FROM daily WHERE brand = LOWER(?)
  GROUP BY date
), others AS (
  SELECT d.date, SUM(d.mentions) AS others_mentions
  FROM daily d
  WHERE d.brand <> LOWER(?)
  GROUP BY d.date
)
SELECT
  COALESCE(l.date, o.date) AS date,
  COALESCE(l.lenovo_mentions, 0) AS lenovo_mentions,
  COALESCE(o.others_mentions, 0) AS others_mentions
FROM lenovo l
FULL OUTER JOIN others o ON l.date = o.date
ORDER BY date;
```
> 参数顺序示例：`start_date, end_date, countryId, brands..., brand_key, brand_key`

---

结论：P12 当前为“静态图片页”，不具备数据驱动能力。若希望与 README 描述一致，需要进行模板与 `charts/p12/` 目录的联动改造，并按上文的指标/口径与生成步骤落地。