# P31 图表需求说明（基于模板与 p31.png）

本文档基于以下素材进行整理：
- 模板：`input/LRTBH-unzip/ppt/slides/slide31.xml` 与关联 `slide31.xml.rels`
- 参考图：`input/LRTBH-images/p31.png`
- 本页实现代码：`charts/p31/make_data.py`

目标：在不改动模板视觉样式的前提下，按渠道输出 Lenovo 的「四周 SOV 趋势」小图，同时保留其他图表的既有填充逻辑与兜底策略。

## 1. 图表清单与范围

- 实际替换清单以 `charts/p31/config.yaml` 的 `output.replace_charts` 为准（节选）：
  - `chart197.xml, chart199.xml, chart198.xml, chart201.xml, chart200.xml, chart203.xml, chart202.xml, chart166.xml, chart205.xml, chart204.xml, chart206.xml, chart165.xml, chart188.xml, chart187.xml, chart190.xml, chart189.xml, chart192.xml, chart191.xml, chart194.xml, chart193.xml, chart196.xml, chart195.xml, chart219.xml, chart218.xml, chart177.xml, chart220.xml, chart179.xml, chart178.xml, chart181.xml, chart180.xml, chart217.xml, chart183.xml, chart182.xml, chart185.xml, chart184.xml, chart186.xml, chart208.xml, chart207.xml, chart210.xml, chart209.xml, chart168.xml, chart212.xml, chart167.xml, chart211.xml, chart170.xml, chart214.xml, chart169.xml, chart213.xml, chart172.xml, chart216.xml, chart171.xml, chart215.xml, chart174.xml, chart173.xml, chart176.xml, chart175.xml`
- 本页以大量小型折线图（lineChart）为主；若模板中存在 scatter 或 bar/pie 等类型，则沿用通用填充策略（见第 3 节）。

## 2. 数据口径与配置

- 品牌集合：`charts/config.yaml -> filters.brands`（品牌标识按小写匹配 keyword_label）
- 国家过滤：`charts/config.yaml -> filters.countryId`
- 时间范围：`compute_metrics.yaml -> time_range.start_date / end_date`（自然日范围）
- 数据库路径：
  - 汇总库：`charts/config.yaml -> data_sources.metrics_db`（默认 `input/metrics_v5.db`）
  - 原始库：`charts/config.yaml -> data_sources.neticle_db`（默认 `input/neticle.sqlite` 或同名 v5）
- 渠道映射：`charts/config.yaml -> channels`
  - 形如：`channels: { "Forum": ["forum"], "YouTube": ["youtube"], ... }`
  - 使用 `mentions_wide.sourceCode` 小写匹配；可按需增补 `sourceType`/`ownChannelName` 方案（后续扩展）
- 渠道顺序（用于文本识别优先级）：`charts/config.yaml -> fill_policy.channel_order`
- X 轴日基值（仅趋势型）：`charts/p31/config.yaml -> fill_policy.axis_day_base`（现为 `20300`）

## 3. 图表类型与数据生成

本页图表按模板类型分三类处理（由 `make_data.py` 自动识别）：

1) 折线图 lineChart（本页小图的主类型）
   - 含义：指定渠道上 Lenovo 的四周 SOV 变化（%）
   - 数据源：`neticle_db.mentions_wide`
   - 计算口径：
     - 时间窗口：`[start_date, end_date]`（闭区间）
     - 将自然日平均切分为 4 个时间段（尽量等长），记为四个 bin；标签展示为 `MM/DD-MM/DD`
     - 过滤：`countryId = filters.countryId`（若配置）
     - 渠道：`LOWER(sourceCode) IN channels[channel]`
     - 品牌集合：`LOWER(keyword_label) IN filters.brands`（小写）
     - SOV（每段）：`lenovo_mentions / all_brands_mentions * 100`，保留 1 位小数
   - 数据结构（写入 `data.json` / `final_data.json`）：
     ```json
     {
       "labels": ["08/01-08/07", "08/08-08/14", "08/15-08/21", "08/22-08/31"],
       "series": [{"name": "YouTube", "values": [12.3, 15.0, 16.1, 14.8]}]
     }
     ```
   - 轴范围：沿用模板轴设置（大多数为 0–100，个别如 `chart206.xml` 为 0–50，保持不改）
   - 样式：沿用模板序列颜色与线型，不在代码层修改样式
   - 兜底：若无法定位渠道或该渠道无数据，则退化为“整月 Lenovo SOV 常数线”
     - 取整月 SOV 百分比的单值 `v`，写入四个点 `v, v, v, v`
     - 标签兜底为 `W1..W4`

2) 散点/线图 scatterChart（若模板存在）
   - 含义：Lenovo vs Others 的日级趋势（Y 为品牌提及数）
   - 数据源：`metrics_db.brand_metrics_day`
   - 计算口径：
     - 品牌集合：`filters.brands`，基准品牌优先 `lenovo`（否则取首个）
     - Others = 其余品牌合计
     - X = `axis_day_base + day_index`
   - 数据结构：
     ```json
     {
       "scatter_series": [
         {"name": "Lenovo", "x": [...], "y": [...], "points": [[x,y], ...]},
         {"name": "Others", "x": [...], "y": [...], "points": [[x,y], ...]}
       ]
     }
     ```

3) 类别图 bar/pie/area/doughnut（若模板存在）
   - 含义：7 品牌月度 SOV（%）
   - 数据源：`metrics_db.brand_metrics_month`
   - 计算口径：当月 `month = start_date[:7]`
   - 数据结构：
     ```json
     {
       "labels": ["Lenovo", "Dell", ...],
       "series": [{"name": null, "values": [25.3, 18.7, ...]}]
     }
     ```

## 4. 渠道-图表绑定（模板解析）

为将每个小图绑定到对应渠道，程序读取模板 XML，按“最近邻文本”匹配：

1) 解析 `slide31.xml.rels`，建立 `rId -> chartXML` 映射
2) 扫描 `slide31.xml`：
   - 收集每个 `p:graphicFrame`（图表）的位置信息（`a:off/a:ext`）
   - 收集每个文本 `p:sp` 的位置信息与内容；对 `a:t` 合并后，若包含 `channel_order` 或 `channels` 中的任意渠道名（大小写不敏感）则视为“渠道标签”
3) 对每个图表，以矩形中心与所有“渠道标签”的中心做欧氏距离比较，取最近者做绑定
4) 得到 `chartXML -> 渠道名` 映射，用于生成对应的小图数据

示例（来自模板文本）：`Forum`, `YouTube` 等（实际以配置中的渠道集合为准）

## 5. 异常与兜底策略

- 原始库/查询为空：写入空结构，构建时由 `original_*.json` 兜底
- 渠道无法识别或该渠道无数据：退化为“整月 Lenovo SOV 常数线（四点相同）”
- 轴范围：严格沿用模板，代码不修改 `c:valAx` 最大/最小值配置

## 6. 生成与验证

步骤：
1) 生成数据：
   ```bash
   cd charts/p31
   python make_data.py
   ```
2) 构建并填充：
   ```bash
   python build.py
   ```
3) 验证要点：
   - 每个小图均为 4 个点；标签形如 `MM/DD-MM/DD`
   - 颜色、线型、Y 轴范围与模板一致（如 `chart206.xml` 为 0–50）
   - 各小图的渠道名与左/上方文本（模板）对应，曲线非全 0（除无数据场景）
   - 若出现“平直四点”，检查：
     - `config.yaml -> channels` 是否覆盖了该渠道的 `sourceCode`
     - `filters.countryId` 是否与数据一致
     - `compute_metrics.yaml` 时间窗口内是否确有该渠道数据

## 7. 可配置项与调优建议

- 渠道映射：在 `config.yaml -> channels` 中增删渠道或补充 `sourceCode`
- 渠道识别优先级：`fill_policy.channel_order` 可调整名称匹配顺序
- 切分策略：当前为“均分四段”，如需自然周（Mon–Sun）可在 `make_data.py` 替换为按周聚合
- 品牌集合：按需在 `filters.brands` 增减；注意与 `mentions_wide.keyword_label` 小写匹配
- 国家：`filters.countryId` 可为空（不加过滤）或指定具体国家 ID

## 8. 兼容与后续扩展

- 兼容 `metrics_v5.db` 的 SOV 与趋势逻辑，避免破坏其他页面
- 渠道可扩展为 `sourceType`/`ownChannelName` 多维组合，或引入更严格的品牌口径规则
- 如需 PPT 内统一调整小图轴范围或数据标注，可在模板层修改对应图表轴与数据标签配置

---

说明：本文档仅描述数据与绑定规则，所有视觉样式（颜色、字体、线宽、轴范围）均以模板为准，不在代码中变更。