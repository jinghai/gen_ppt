# P21 纠正说明（图表类型、口径与实现一致性）

- 结论速览
  - 本页包含 4 个图表：chart30.xml、chart31.xml、chart32.xml、chart33.xml。
  - 4 个图表的实际类型均为 barChart（类别图，7 品牌 SOV）。
  - 现有 readme 将 chart33 描述为 “Lenovo vs Others 趋势图（线/散点）”与事实不符，应修正为 SOV 类别图。
  - 配置中的 `axis_day_base` 不影响本页（无折线/散点图），可保留以统一配置。

- 证据与定位
  - slide21 关系：ppt/slides/_rels/slide21.xml.rels 指向 chart30.xml ~ chart33.xml。
  - 类型判定：
    - charts/p21/chart30/original_meta.json → `"chart_type": "barChart"`
    - charts/p21/chart31/original_meta.json → `"chart_type": "barChart"`
    - charts/p21/chart32/original_meta.json → `"chart_type": "barChart"`
    - charts/p21/chart33/original_meta.json → `"chart_type": "barChart"`
  - 配置：charts/p21/config.yaml 中 `replace_charts` 为 chart30.xml ~ chart33.xml，`final_mode: updated`，`axis_day_base: 20300`（对本页无实质影响）。
  - 实现：charts/p21/make_data.py 中，bar/pie/area/doughnut 统一走 `make_sov`，与上述类型一致。

- 正确的数据源与口径（SOV）
  - 表：`brand_metrics_month`（月度聚合）。
  - 时间：取 `compute_metrics.yaml.time_range.start_date` 所在月份（YYYY-MM）。
  - 过滤：`brand IN cfg.brands_order`（顺序同全局 brands 配置）。
  - 口径：
    - 分子：各品牌 `brand_mentions` 按品牌汇总（跨国家求和）。
    - 分母：对每个 `(countryId, month)` 取 `total_mentions` 的最大值后求和。
    - 计算：SOV = round(brand_mentions_sum / denom * 100, 1)。
  - SQL 参考（与实现一致）：
    ```sql
    -- month_param 取 start_date 对应的 YYYY-MM；brands(...) 由 cfg.brands_order 提供
    WITH f AS (
      SELECT countryId, month, brand, brand_mentions, total_mentions
      FROM brand_metrics_month
      WHERE month = ?
        AND brand IN (?, ?, ?, ?, ?, ?, ?)
    ), denom AS (
      SELECT SUM(mx) AS denom
      FROM (
        SELECT countryId, month, MAX(total_mentions) AS mx
        FROM f
        GROUP BY countryId, month
      )
    ), numer AS (
      SELECT brand, SUM(brand_mentions) AS num
      FROM f
      GROUP BY brand
    )
    SELECT brand, ROUND(num / (SELECT denom FROM denom) * 100.0, 1) AS sov
    FROM numer
    ORDER BY brand; -- 实际顺序由代码按 cfg.brands_order 重排
    ```

- 建议的文档修订点（readme）
  - 将 “chart33 为 Lenovo vs Others 趋势” 改为 “chart33 为 7 品牌 SOV 类别图（barChart）”。
  - 删除/下移与趋势图（line/scatter）相关的算法与示例至通用说明区，或标注“本页未使用”。
  - 保留 `axis_day_base` 的配置解释，但注明对本页无影响。

- 实施核对清单（本页应满足）
  - [x] 4 个 original_meta.json 类型均为 `barChart`。
  - [x] `make_data.py` 对四个图表均调用 `make_sov` 并生成 `data.json/final_data.json`（labels+series）。
  - [x] config.yaml 的 replace_charts 覆盖 chart30.xml~chart33.xml。
  - [x] 生成后可执行 `python build.py` 完成图表替换。

- 可选增强（非必须）
  - 输出小数位统一为 1 位（当前实现已执行 round(..., 1)）。
  - 若需“全市场”或“指定国家”口径，可新增配置项控制是否在 SQL 中限定 countryId。