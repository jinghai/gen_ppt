# P25 纠正说明（结论版）

本页为“高密度日级趋势页”。经对比页面截图（input/LRTBH-images/p25.png）、模板关系文件（slide25.xml.rels）与本页目录、配置及原始图表元数据确认：
- 实际包含 28 个图表，目录为 `chart83` 至 `chart110`（共 28 个）。
- 28 个图表均为 `lineChart` 类型，呈现“Lenovo vs Others”的日级趋势；不包含 SOV 类别图。
- 数据仅需来自日级表 `brand_metrics_day`；无需 `brand_metrics_month`。
- JSON 输出为散点/折线统一格式 `scatter_series`，X 轴采用 `axis_day_base` 映射的数轴值。

以上与当前 readme.md 的叙述不一致：readme 将本页描述为“27 个 SOV + 1 个趋势”，且列举了错误的图表编号范围（含 chart65–82）。应予以更正。

---

## 证据与核验
- 目录结构：`charts/p25` 下存在 `chart83`–`chart110` 共 28 个子目录，数量与页面布局一致。
- 配置文件：`charts/p25/config.yaml` 中 `output.replace_charts` 全为 chart83–110 范围（含 90–93、…、110），并设置 `final_mode: updated`，`fill_policy.axis_day_base: 20300`。
- 原始元数据：逐个检查 `charts/p25/chartXX/original_meta.json`，`chart_type` 均为 `lineChart`（示例：chart83、chart90、chart91、chart93、chart100、chart110 等）。
- 数据生成脚本：`charts/p25/make_data.py` 对 `scatterChart`/`lineChart` 统一调用 `make_trend_lenovo_vs_others` 并输出 `scatter_series`；类别图（bar/pie/area/doughnut）才会走 `make_sov`。结合元数据，p25 全部命中趋势分支。

结论：p25 全部为“Lenovo vs Others”日级趋势折线/散点填充，无 SOV 图。

---

## 正确的数据源与指标
- 表：`brand_metrics_day`
- 维度：`day`（YYYY-MM-DD），`brand`
- 指标：`brand_mentions`（日级品牌提及数）
- 品牌集：来自全局 `charts/config.yaml` 的 `filters.brands`，其中基准品牌为 `lenovo`（若不在列表，则取第一品牌为基准）。
- Others 定义：同日“非基准品牌”的 `brand_mentions` 之和。
- 国家聚合：按 `make_data.py` 实现，针对日与品牌聚合后再“跨国家求和”，不拆国家维度。

无需新增任何指标或表结构。

---

## 计算方法与轴映射
1) 取时间窗口：`start_date`–`end_date`（来自 `compute_metrics.yaml.time_range`，如缺失按代码默认）。
2) 查询 `brand_metrics_day` 并按 `day, brand` 聚合求和。
3) 对每个自然日 d：
   - `lenovo_y(d) = sum(brand_mentions where brand = 'lenovo' and day = d)`
   - `others_y(d) = sum(brand_mentions where brand != 'lenovo' and day = d)`
4) X 轴映射：`x[i] = axis_day_base + i + 1`，其中 `axis_day_base = 20300`，`i` 为从 0 开始的日序索引。
5) 输出 `scatter_series` 两条序列：`Lenovo` 与 `Others`，均包含 `x[]`, `y[]`, `points[[x,y]]`。

示例 SQL 片段（与实现一致，示意逻辑）：
```sql
-- 取时间窗和品牌集
SELECT day, brand, SUM(brand_mentions) AS brand_mentions
FROM brand_metrics_day
WHERE day BETWEEN :start_date AND :end_date
  AND brand IN (:brands...)
GROUP BY day, brand;
```
随后在代码侧对同一天将 `lenovo` 与“非 lenovo”的提及数分别累加，映射到 `x = 20300 + 序号`。

---

## JSON 数据格式（折线/散点统一）
```json
{
  "scatter_series": [
    {"name": "Lenovo", "x": [20301, 20302, ...], "y": [...], "points": [[20301, ...], ...]},
    {"name": "Others", "x": [20301, 20302, ...], "y": [...], "points": [[20301, ...], ...]}
  ]
}
```

---

## 对 readme.md 的修订建议（要点）
- 页面性质：改为“28 个趋势图（全部为 Lenovo vs Others 日级趋势）”。
- 图表清单：改为 `chart83.xml`–`chart110.xml`（28 个），与 `config.yaml` 对齐；去除 `chart65`–`chart82` 等无关编号。
- 数据源：仅保留 `brand_metrics_day`；删除 `brand_metrics_month` 与 SOV 相关叙述与示例。
- 算法说明：保留并聚焦 `make_trend_lenovo_vs_others`；删除/合并 SOV 章节。
- 数据格式：仅保留 `scatter_series` 说明，标注 `axis_day_base: 20300` 的 X 轴映射规则。

---

## 实施与校验清单
- 配置确认：`charts/p25/config.yaml` 已设置 `final_mode: updated`、`axis_day_base: 20300`。
- 生成数据：`cd charts/p25 && python make_data.py`
- 校验一致性：`python validate.py`（校验原始 vs 模板维度、数据量不低于原始）
- 构建填充：`python build.py` 或在上层使用批量脚本

如需统一编号展示顺序，建议在 readme 的“替换图表列表”中按 `chart83.xml` → `chart110.xml` 递增列出，以减少认知成本。

---

## 结论
- p25 的全部 28 张图表是 `lineChart`，用于“Lenovo vs Others”的日级趋势展示。
- 仅需 `brand_metrics_day`；无需新增指标或使用 `brand_metrics_month`。
- 输出 `scatter_series` 即可完成折线/散点模板的数据填充。