# P14 纠正说明（7 品牌 SOV 汇总，无趋势图）

一、图表理解纠正
- 模板核对：slide14.xml.rels 引用的图表为 chart12.xml、chart13.xml、chart14.xml、chart15.xml、chart16.xml，均为 c:barChart，且为横向堆叠（barDir="bar"，grouping="stacked"），页面内不包含 scatter/line 趋势图。
- 现有 readme 描述了“类别图 + Lenovo vs Others 日级趋势”，与模板不一致。应将本页定位为“7 品牌 SOV（份额）汇总看板”，由 5 张横向堆叠条形图组成（通常总和为 100%）。
- p14/make_data.py 的逻辑：检测图表类型后，bar/pie/area/doughnut 走 make_sov；scatter/line 走 make_trend_lenovo_vs_others。由于模板均为 barChart，本页实际只会输出 SOV 类别数据。

二、建议呈现与指标补充
- SOV 总览：每张图展示 7 个品牌在当月的份额（总和 100%，保留 1 位小数）。
- Top 与差距：突出 Top1~Top3 品牌，并给出与 Lenovo 的份额差（Gap = SOV(top) - SOV(Lenovo)）。
- 集中度（HHI，可选）：HHI = Σ(SOV_i^2)，用于衡量市场份额集中度，阈值提示“竞争是否分散”。
- 环比/同比变化：对比上月/去年同月 SOV 变化（ΔSOV），指明份额提升或下降的品牌。
- Others 汇总（可选）：若品牌清单之外仍有长尾品牌，可单列 Others 使总和严格为 100%。

三、数据口径与计算校正
- 当前实现问题：
  - p14/make_data.py 的 make_sov 未按 countryId 过滤，仅按 month 和 brand 过滤，易引入跨国家的数据混入。
  - 分母 denom 取“对 (countryId, month) 分组后的 total_mentions 最大值再求和”，语义不清。通常 total_mentions 在同一个 (countryId, month) 上对所有品牌相同；分母应为“所选品牌的 brand_mentions 之和”，或为单一的 total_mentions（若该字段代表当期总声量且不重复）。
- 建议修正：
  - 在 Config 中加入 country_id，并在 SQL 中按国家过滤：`WHERE month=:month AND countryId=:countryId AND brand IN (...)`。
  - 分母推荐：`denom = Σ_brand brand_mentions`（对所选 7 品牌，按国家与月份过滤后求和）。
  - 品牌匹配：建议统一小写匹配或强制大小写一致，避免“Lenovo/lenovo/Lenovo Group”等命名差异导致漏计。

四、计算方法（落地示例）
- 月度 SOV（百分比）：
  - 选择表：`brand_metrics_month`
  - 过滤：`month = :month`，`countryId = :countryId`，`brand IN (:brands)`
  - 计算：
    - `brand_mentions_b = Σ(brand_mentions WHERE brand=b)`
    - `denom = Σ_b(brand_mentions_b)`
    - `SOV_b = round(brand_mentions_b / denom * 100, 1)`
- SQL 示例（SQLite）：
  ```sql
  -- 汇总每个品牌当月声量
  WITH agg AS (
    SELECT brand, SUM(COALESCE(brand_mentions,0)) AS bm
    FROM brand_metrics_month
    WHERE month = :month
      AND countryId = :countryId
      AND brand IN (:b1,:b2,:b3,:b4,:b5,:b6,:b7)
    GROUP BY brand
  ), denom AS (
    SELECT SUM(bm) AS total_bm FROM agg
  )
  SELECT a.brand, a.bm, ROUND(a.bm / NULLIF(d.total_bm,0) * 100.0, 1) AS sov
  FROM agg a CROSS JOIN denom d
  ORDER BY FIELD(a.brand, :b1,:b2,:b3,:b4,:b5,:b6,:b7);
  ```
- 缺失品牌：若某品牌当月无数据，应补 0 并保留顺序，与 `filters.brands` 一致。

五、与代码对齐的实现要点
- 在 make_data.py：
  - 扩展 Config：加入 `country_id: int`；
  - SQL 增加 `countryId = ?` 过滤；
  - 分母改为 Σ_brand brand_mentions；
  - 输出顺序按 `brands_order` 对齐；
  - 最终写入：`{"labels": brands, "series": [{"name": null, "values": sov_list}]}`。
- 预览与回退：保留 `original_*` 作为兜底；barChart 无需 `axis_day_base`。

六、校验清单
- 模板类型：p14 的 5 张图均为 barChart（横向堆叠），无趋势图。
- 数据口径：按国家、月份、品牌集合过滤；分母为所选品牌总声量；总和 100%。
- 品牌顺序：与 config.yaml 的 `filters.brands` 保持一致；缺失品牌补 0。
- 展示增强：Top/Gap、ΔSOV、HHI、Others（可选）。

结论：
- 本页定位为“7 品牌 SOV 汇总”更准确；readme 中“Lenovo vs Others 日级趋势”应移至真正包含趋势图的页面（例如后续页面），或在模板改动为 scatter/line 后再启用。
- 建议修正 make_sov 的国家过滤与分母计算，保证份额口径严谨且与业务预期一致。