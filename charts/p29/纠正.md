# P29 纠正说明 — Media Channels Share of Voice（渠道内 SOV，多系列）

## 结论摘要
- 原实现将本页当作“7 品牌整体 SOV（单系列）”，与模板不符。
- 模板原始图表（chart115.xml）包含 7 个系列、每个系列 6 个值，明确是“多品牌 × 渠道”的分组柱状图。
- 正确理解：X 轴为 6 个渠道类别；Series 为 7 个品牌；Y 为“该渠道内的品牌 Share of Voice（%）”。每个渠道内各品牌占比之和为 100%。

## 图表与口径
- 图表类型：分组柱状图（barChart）。
- 类别（X 轴）：渠道，按全局配置 `config.yaml.fill_policy.channel_order`
  - 默认顺序：`["Online News", "Forum", "Blog", "X", "Instagram", "YouTube"]`
- 系列（Series）：7 品牌，按 `config.yaml.filters.brands_display`
  - 默认：`["Lenovo", "Dell", "HP", "ASUS", "Acer", "Apple", "Samsung"]`
- 指标（Y 轴）：渠道内 SOV（%）。定义如下：
  - 在指定时间窗口与国家口径下，统计每个渠道中 7 个品牌的加权提及量（定义见下）。
  - 渠道内 SOV(brand, channel) = weighted_mentions(brand, channel) / Σ weighted_mentions(all 7 brands, channel) × 100。

## 数据源与映射
- 基础库：`neticle-v5-08.sqlite`（路径见 `config.yaml.data_sources.neticle_db`）。
- 表：`mentions_wide`
- 关键字段：
  - `countryId`：国家过滤（France=39）。
  - `createdAtUtcMs`：UTC 毫秒时间戳，用于时间窗口过滤（`update.start_date` 至 `update.end_date`，闭区间按 [start, next_day_of_end)）。
  - `sourceName`：来源类型（如 `article`, `blog`, `forum`, `twitter`, `instagram`, `video`, `frontpage`, `comment` 等）。
  - `brandLabelNames`：该条 mention 被标注的品牌名称集合（以 `|` 分隔）。
- 渠道映射：使用 `config.yaml.channels`（原子来源 → 目标渠道名称）。例如：
  - Online News: `article`, `frontpage`, `comment` ...
  - Forum: `forum`
  - Blog: `blog`
  - X: `twitter`
  - Instagram: `instagram`
  - YouTube: `video`/`youtube`

## 新指标与计算口径
- 新增“品牌×渠道加权提及量”`weighted_mentions(brand, channel)`：
  - 对每条 mention：
    - 先将 `sourceName` 归并到目标渠道；
    - 解析 `brandLabelNames`（按 `|` 分隔，转小写），取与 7 品牌集合的交集；
    - 若该交集为空，则忽略此 mention；
    - 否则将 1 按交集内品牌平均分配：每个命中的品牌获得 `1 / 命中品牌数` 的权重（避免多品牌重复计数导致渠道合计>100%）。
- 渠道内 SOV：
  - 对每个渠道，先聚合得到 7 品牌的 `weighted_mentions`；
  - 渠道合计作为分母，按品牌占比分配为百分比，保留 1 位小数。

## 计算方法（伪代码/SQL 提示）
- 过滤 SQL（仅取需要的字段与来源）：
```sql
SELECT sourceName AS src, brandLabelNames AS brands
FROM mentions_wide
WHERE countryId = :countryId
  AND createdAtUtcMs >= :startMs AND createdAtUtcMs < :endMs
  AND brandLabelCount > 0
  AND sourceName IN (:rawSourceNames...)
```
- 归并与加权（伪代码）：
```python
channel = channel_name_map.get(src.lower())
labels = [t.strip().lower() for t in brands.split('|') if t]
present = [t for t in labels if t in brands_set]  # 7 品牌集合
if present:
    w = 1.0 / len(present)
    for b in present:
        counts[b][channel] += w
```
- 渠道内 SOV：
```python
denom = sum(counts[b][channel] for b in brands_order)
sov = round(counts[brand][channel] / denom * 100.0, 1) if denom>0 else 0.0
```

## 输出数据结构
- JSON（data.json / final_data.json）：
```json
{
  "labels": ["Online News","Forum","Blog","X","Instagram","YouTube"],
  "series": [
    {"name": "Lenovo",  "values": [..6 渠道百分比..]},
    {"name": "Dell",    "values": [..] },
    {"name": "HP",      "values": [..] },
    {"name": "ASUS",    "values": [..] },
    {"name": "Acer",    "values": [..] },
    {"name": "Apple",   "values": [..] },
    {"name": "Samsung", "values": [..] }
  ]
}
```
- 与模板一致：7 个系列 × 6 个类别。

## 实施变更
- 更新 `charts/p29/make_data.py`：
  - 扩展配置加载，读取 `filters.countryId`、`data_sources.neticle_db`、`fill_policy.channel_order`、`channels` 映射及 `brands_display`。
  - 新增 `make_channel_sov_by_brand`：基于 neticle 的 `mentions_wide` 直接计算“渠道内 SOV（多系列）”。
  - `barChart` 路径改为走上述新逻辑，输出多系列结构；其他图表类型保留原有兼容逻辑。
- 不修改 `charts/p29/config.yaml`（仍由根级 `config.yaml` 统一控制时间/渠道口径）。

## 校验建议
- 结构校验：
  - 确认 `final_data.json.series` 长度为 7，每个 `values` 长度为 6。
  - 对每个渠道（相同下标）抽样验证 7 品牌百分比之和≈100%。
- 结果抽查：
  - 统计 FR+当月+`sourceName in (article, blog, forum, twitter, instagram, video, frontpage, comment)` 的 mention 数；
  - 随机抽取含多品牌标签的样本，确认加权分配符合 1/N 规则。
- 性能：
  - 如数据量较大，可在 SQL 中限定 `sourceName` 列表减少扫描；
  - 必要时可分批按日载入累加。

---
