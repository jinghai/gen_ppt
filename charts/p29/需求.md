# P29页面需求文档 - 联想法国市场媒体渠道声量份额分析

## 项目概述

本项目旨在生成P29页面的PPT，展示联想品牌在法国市场2025年8月各媒体渠道的声量份额分析。页面包含两个主要图表：左侧堆叠柱状图展示各渠道品牌分布，右侧饼图展示整体品牌声量份额。

## 数据源

### 主要数据库
- **neticle数据库**: `../../input/neticle-v4-08.sqlite`（相对于P29目录）
  - 主表：`mentions_wide` - 包含丰富的提及数据
  - 字段：sourceName, keyword_label, sumInteractions, polarity等
- **metrics数据库**: `../../input/metrics-v4-08.db`（相对于P29目录）
  - 预计算指标表（如需要）

### 数据筛选条件
- **国家**: 法国 (countryId = 39)
- **时间范围**: 2025年8月1日 - 2025年8月31日（UTC时间戳转换）
- **品牌范围**: lenovo, dell, hp, asus, acer, apple, samsung（小写匹配）
- **品牌标识**: 使用keyword_label字段进行部分匹配（如"lenovo"匹配"Lenovo-FR-V5"）

## 渠道映射需求

根据config.yaml中的渠道配置，需要将数据库中的sourceName字段映射到以下6个目标渠道：

### 1. Forum（论坛）
- 数据源：forum, forum_aggregator

### 2. Online News（在线新闻）
- 数据源：article, frontpage, article_aggregator, frontpage_aggregator, comment, comment_article

### 3. Blog（博客）
- 数据源：blog, blog_aggregator, comment_blog

### 4. X（原Twitter）
- 数据源：twitter, twitter_reply, twitter_retweet, twitter_quoted

### 5. Instagram
- 数据源：instagram, instagram_post, instagram_comment, instagram_reply

### 6. YouTube
- 数据源：youtube, video

**注意**: 映射时使用sourceName.lower()进行小写匹配，未匹配的源归类为"Other"渠道

## 图表数据需求

### 左侧堆叠柱状图数据
**结构**: 6个渠道 × 7个品牌的矩阵数据
**计算方式**: 每个渠道内各品牌的声量份额百分比（四舍五入到小数点后1位）
**公式**: 品牌在渠道X的份额 = (品牌在渠道X的提及数 / 渠道X的总提及数) × 100%

**品牌显示顺序**: Lenovo, Dell, Apple, HP, ASUS, Acer, Samsung
**渠道显示顺序**: Forum, Online News, Blog, X, Instagram, YouTube

### 右侧饼图数据
**结构**: 7个品牌的整体声量份额
**计算方式**: 各品牌在所有渠道的总提及数占比，使用最大余数法确保总和为100%
**公式**: 品牌总份额 = (品牌总提及数 / 所有品牌总提及数) × 100%

**最大余数法说明**: 
- 先按精确配额取地板值
- 再按余数大小分配剩余点数
- 严格保证总和为100%，避免四舍五入误差

## 技术实现要求

### 1. 数据生成脚本 (generate_excel.py)
- 从neticle数据库提取法国8月数据
- 实现渠道映射逻辑（sourceName -> 目标渠道）
- 品牌名称归一化（使用brands_display配置）
- 计算各渠道品牌声量份额（四舍五入到1位小数）
- 计算整体品牌声量份额（最大余数法分配整数百分比）
- 生成Excel文件供人工验证和修改

### 2. Excel输出文件
- **文件名**: `p29_data.xlsx`
- **工作表1**: `原始数据` - 从数据库提取的原始提及数据
- **工作表2**: `渠道SOV数据` - 各渠道内品牌声量份额数据
- **工作表3**: `品牌总体SOV` - 品牌总体声量份额数据（整数百分比）
- **工作表4**: `Sheet1` - 重构后的矩阵格式数据（用于PPT图表绑定）

#### Excel样式功能
- **标题行样式**: 加粗字体，居中对齐
- **数据格式**: 数值保持原始精度，便于后续处理
- **工作表标题**: 每个工作表第一行包含描述性标题

### 3. PPT填充脚本 (fill_from_excel.py)
- 基于模板 `p29.pptx` 生成最终PPT
- 优先从Excel的Sheet1读取柱状图数据（保留手动修改）
- 从"品牌总体SOV"工作表读取饼图数据
- 更新嵌入的Excel数据源并启用自动刷新
- 应用品牌颜色映射（基于config.yaml配置）
- 规范数据标签样式（bestFit位置，0\%格式，品牌特定颜色）
- 生成最终文件到 `output/p29-final.pptx`

### 4. 数据标签处理功能
- **位置策略**: 使用bestFit自动定位，避免重叠
- **格式统一**: 采用自定义格式"0\%"显示百分比（不进行*100缩放）
- **颜色规则**: Apple品牌使用黑色标签，其他品牌使用白色标签
- **可选隐藏**: 支持通过min_label_percent配置隐藏小比例标签（默认0，不隐藏）

### 5. 品牌颜色配置
根据config.yaml中的brand_colors配置：
- **Lenovo**: FF0000 (红色)
- **Dell**: 4E5AFF (蓝色)  
- **Apple**: BEBEBE (灰色)
- **HP**: 43A7D0 (青色)
- **ASUS**: E935A8 (粉色)
- **Acer**: 0AA0A9 (青绿色)
- **Samsung**: 142D5C (深蓝色)

## 质量保证要求

### 1. 数据验证
- 每个渠道的品牌份额总和应为100%（允许四舍五入误差）
- 整体品牌份额总和严格为100%（最大余数法保证）
- 数据应反映实际的数据库查询结果
- 支持空数据处理（total_mentions为0时SOV为0.0）

### 2. 文件完整性
- Excel文件应包含4个工作表，每个工作表有描述性标题
- PPT文件应保持模板的原始格式和样式
- 图表应可在PowerPoint中正常编辑和自动刷新
- 嵌入的Excel数据源应与生成的Excel文件同步

### 3. 错误处理
- 处理数据缺失情况（使用0.0填充）
- 验证渠道映射的完整性（未匹配源归为"Other"）
- 确保品牌名称的一致性（使用brands_display配置）
- Sheet1布局验证（表头和行标签必须匹配配置）
- 不允许兜底处理，应该明确报错而非掩盖问题

### 4. 临时文件管理
- 使用页面级临时目录 `charts/p29/tmp`
- 避免污染项目根目录
- 保留临时文件用于调试（chart_data.json, ppt_extracted/）

## 输出文件

1. **数据文件**: `p29_data.xlsx`
2. **最终PPT**: `output/p29-final.pptx`


## 项目依赖

- Python 3.x
- pandas >= 2.2.2
- openpyxl >= 3.1
- sqlite3 (内置)
- lxml >= 5.2.1
- yaml (PyYAML)
- pathlib (内置)
- 其他依赖见项目根目录 requirements.txt

## 注意事项

1. 模板PPT文件 `p29.pptx` 不可被程序修改，只能读取
2. 需要处理PPT解压、数据嵌入、重新打包的完整流程
3. 确保生成的PPT在PowerPoint中可正常打开和编辑
4. 数据时间范围严格限制在2025年8月（UTC时间戳转换）
5. 品牌名称映射使用小写部分匹配，支持多语言标签格式
6. 遵循MVP原则，避免过度设计
7. 完善的代码注释，便于维护和扩展
8. 禁止使用兜底处理，应该明确报错