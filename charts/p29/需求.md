# P29页面需求文档 - 联想法国市场媒体渠道声量份额分析

## 项目概述

本项目旨在生成P29页面的PPT，展示联想品牌在法国市场2025年8月各媒体渠道的声量份额分析。页面包含两个主要图表：左侧堆叠柱状图展示各渠道品牌分布，右侧饼图展示整体品牌声量份额。

## 数据源

### 主要数据库
- **neticle数据库**: `/Users/jinghai/coder/gen_ppt/input/neticle-v5-08.sqlite`
  - 主表：`mentions_wide` - 包含丰富的提及数据
  - 辅助表：`sources` - 渠道信息映射
- **metrics数据库**: `/Users/jinghai/coder/gen_ppt/input/metrics_v5-08.db`
  - 预计算指标表（如需要）

### 数据筛选条件
- **国家**: 法国 (countryId = 39)
- **时间范围**: 2025年8月1日 - 2025年8月31日
- **品牌范围**: Lenovo, Dell, HP, ASUS, Acer, Apple, Samsung
- **品牌标识**: 使用keyword_label字段，格式为"{Brand}-FR-V5"

## 渠道映射需求

根据config.yaml中的渠道配置，需要将数据库中的sources.name映射到以下6个目标渠道：

### 1. Forum（论坛）
- 数据源：forum, forum_aggregator

### 2. Online News（在线新闻）
- 数据源：article, frontpage, article_aggregator, frontpage_aggregator, comment, comment_article

### 3. Blog（博客）
- 数据源：blog, blog_aggregator, comment_blog

### 4. X（原Twitter）
- 数据源：twitter, twitter_reply, twitter_retweet, twitter_quoted

### 5. Instagram
- 数据源：instagram, instagram_post, instagram_comment, instagram_reply

### 6. YouTube
- 数据源：video（YouTube相关视频内容）

## 图表数据需求

### 左侧堆叠柱状图数据
**结构**: 6个渠道 × 7个品牌的矩阵数据
**计算方式**: 每个渠道内各品牌的声量份额百分比
**公式**: 品牌在渠道X的份额 = (品牌在渠道X的提及数 / 渠道X的总提及数) × 100%

**预期数据格式**:
```
渠道        Lenovo  Dell   Apple  HP     ASUS   Acer   Samsung
Forum       26%     16%    26%    9%     15%    5%     3%
Online News 20%     19%    31%    8%     15%    5%     2%
Blog        16%     17%    28%    20%    11%    4%     4%
X           28%     5%     51%    5%     9%     1%     1%
Instagram   15%     19%    39%    10%    12%    3%     2%
YouTube     8%      14%    37%    6%     23%    7%     5%
```

### 右侧饼图数据
**结构**: 7个品牌的整体声量份额
**计算方式**: 各品牌在所有渠道的总提及数占比
**公式**: 品牌总份额 = (品牌总提及数 / 所有品牌总提及数) × 100%

**预期数据格式**:
```
品牌      份额
Apple     41%
Lenovo    23%
ASUS      12%
Dell      11%
HP        8%
Acer      3%
Samsung   2%
```

## 技术实现要求

### 1. 数据处理脚本 (make_data.py)
- 从neticle数据库提取法国8月数据
- 实现渠道映射逻辑
- 计算各渠道品牌声量份额
- 计算整体品牌声量份额
- 生成Excel文件供人工验证

### 2. Excel输出文件
- **文件名**: `p29_data.xlsx`
- **工作表1**: `Sheet1` - 重构后的渠道品牌声量份额数据（用于PPT嵌入）
- **工作表2**: `渠道SOV数据` - 原始渠道声量份额数据
- **工作表3**: `品牌总体SOV` - 品牌总体声量份额数据
- **工作表4**: `原始统计` - 原始统计数据（用于验证）

#### Excel样式增强功能
- **字体颜色自动对比**: 根据品牌底色亮度自动选择黑色或白色字体，确保文字清晰可读
  - 亮色背景（相对亮度 ≥ 0.55）：使用黑色字体 (`FF000000`)
  - 暗色背景（相对亮度 < 0.55）：使用白色字体 (`FFFFFFFF`)
  - 采用W3C相对亮度计算标准，公式：`L = 0.2126×R + 0.7152×G + 0.0722×B`
- **品牌底色映射**: 表头和数据单元格底色与PPT图表系列颜色保持一致
- **字体加粗**: 表头使用加粗字体以突出显示

### 3. PPT生成器
- 基于模板 `/Users/jinghai/coder/gen_ppt/charts/p29/p29.pptx`
- 读取Excel数据并嵌入到PPT中
- 生成最终文件 `p29-final.pptx` 到 `output` 目录
- 确保图表数据可在PowerPoint中编辑

### 4. 颜色配置
根据图表解释文档，品牌颜色配置：
- **Lenovo**: 红色
- **Dell**: 蓝色  
- **Apple**: 灰色
- **HP**: 青色
- **ASUS**: 粉色
- **Acer**: 绿色
- **Samsung**: 深蓝色

## 质量保证要求

### 1. 数据验证
- 每个渠道的品牌份额总和应为100%
- 整体品牌份额总和应为100%
- 数据应与图表解释文档中的预期值基本一致

### 2. 文件完整性
- Excel文件应包含完整的数据和适当的格式
- PPT文件应保持模板的原始格式和样式
- 图表应可在PowerPoint中正常编辑

### 3. 错误处理
- 处理数据缺失情况
- 验证渠道映射的完整性
- 确保品牌名称的一致性

## 输出文件

1. **需求文档**: `p29/需求.md` ✓
2. **数据文件**: `p29/p29_data.xlsx`
3. **最终PPT**: `p29/output/p29-final.pptx`
4. **更新文档**: `p29/readme.md`

## 项目依赖

- Python 3.x
- pandas >= 2.2.2
- openpyxl >= 3.1
- sqlite3 (内置)
- lxml >= 5.2.1
- 其他依赖见 requirements.txt

## 注意事项

1. 模板PPT文件不可被程序修改，只能读取
2. 需要处理PPT解压、数据嵌入、重新打包的完整流程
3. 确保生成的PPT在PowerPoint中可正常打开和编辑
4. 数据时间范围严格限制在2025年8月
5. 品牌名称映射需要准确匹配数据库中的keyword_label格式