# P16 纠正说明（7 张趋势图，均为 lineChart）

一、模板与实现核对
- slide16.xml.rels 引用 7 个图表：chart17.xml, chart18.xml, chart19.xml, chart20.xml, chart21.xml, chart22.xml, chart23.xml。
- 每个 chart* 的 original_meta.json 标注 chart_type = lineChart，模板不包含 bar/pie/area/doughnut 图。
- 现有 readme 描述了“类别图 + 趋势图”的混合形态，与模板不一致。P16 实际是“7 张日级趋势图”，无 SOV 类别图。
- make_data.py 会按图表类型分支：lineChart→生成日级趋势（Lenovo vs Others），bar/pie/area/doughnut→生成 SOV；因此本页实际仅走“趋势”分支。

二、现实现状与问题
- 趋势口径：当前 make_trend_lenovo_vs_others 未按国家过滤；仅按 day、brand 过滤，存在跨国家混入风险。
- 品牌映射：base_brand 固定为 'lenovo'（或 brands[0]），导致 7 张 line 图全部生成相同两条序列（Base vs Others），与“每图对应不同品牌”的常见设计不符。
- X 轴：按 `axis_day_base + 序号` 映射为浮点（满足部分模板“数字 x 轴”需求），该规则合理。

三、建议目标形态（按图位绑定品牌）
- 7 张小图：每张展示“某品牌 vs Others”的日级趋势，两条线：
  - 序列1：当前品牌日声量（brand_mentions）
  - 序列2：Others（其余所选品牌的日声量之和）
- 品牌绑定：按 chart 目录排序与品牌顺序一一对应，例如：
  - chart17 → brands[0]
  - chart18 → brands[1]
  - ...
  - chart23 → brands[6]
  如模板存在不同排版顺序，可通过 `config.yaml.output.replace_charts` 明确映射数组来驱动绑定。

四、数据口径与计算规范
- 过滤维度：`countryId = :countryId`（新增配置），`day BETWEEN :start_date AND :end_date`，`brand IN :brands`。
- Others 定义：Others(day) = Σ_all_brands(day) - BaseBrand(day)。
- 缺失填充：若某日缺值，按 0 填补，保证时间轴连续。
- 平滑与异常（可选）：可提供 MA7（7 日移动均值）作为参数开关，异常值 winsorize（如 1%/99%）或阈值裁剪。

五、SQL/实现示例（SQLite）
- 按国家与品牌集合取日级：
  ```sql
  SELECT day, brand, SUM(COALESCE(brand_mentions,0)) AS bm
  FROM brand_metrics_day
  WHERE day BETWEEN :start_date AND :end_date
    AND countryId = :countryId
    AND brand IN (:b1,:b2,:b3,:b4,:b5,:b6,:b7)
  GROUP BY day, brand;
  ```
- Python 侧（建议）：
  - 在 make_data.py main 循环中，按 chart_dir 排序获取 index i；base_brand = brands[i % len(brands)]；调用 `make_trend_lenovo_vs_others(cfg, conn, base_brand)`（新增参数）。
  - 函数内部：
    1) 读表并按国家、日、品牌过滤与聚合；
    2) days = 全量日期列表；
    3) `y_base[d] = bm(day, base_brand)`；`y_others[d] = Σ_bm(day, brand≠base_brand)`；
    4) x = axis_day_base + 1..N；
    5) 返回 `[{'name': Base, 'x': x, 'y': y_base, 'points': ...}, {'name': 'Others', ...}]`。

六、与现有代码的对齐修改点
- Config 扩展：
  - 在全局 `config.yaml` 的 `filters` 下新增 `country_id`；p16/_load_yaml_cfg 读取该字段。
- SQL 修正：
  - `FROM brand_metrics_day WHERE countryId = ? AND day BETWEEN ? AND ? AND brand IN (...)`。
- 多图品牌绑定：
  - main() 遍历 chartN 时，计算 chart_index 并确定 base_brand；
  - 将 `make_trend_lenovo_vs_others(cfg, conn)` 改为 `make_trend_lenovo_vs_others(cfg, conn, base_brand)`。
- 品牌大小写：
  - 统一 `brands_order` 为小写再比对，输出名称再 `capitalize()` 或按自定义映射美化。

七、校验清单
- 模板核验：7 张均为 lineChart（已由 original_meta.json 验证）。
- 口径一致：单一国家；品牌集合一致；日级完整；缺失补 0。
- 映射正确：chart17..23 分别对应 brands[0..6] 的“Brand vs Others”。
- 输出结构：scatter_series 含 x/y/points；x 单调递增。

结论：
- P16 为“7 张日级趋势图”页面，readme 中的 SOV 类别图描述应删除；应补充国家过滤、图位到品牌的绑定逻辑，避免 7 张图重复显示同一（Lenovo）序列，确保页面表达符合竞品多品牌对比的设计意图。