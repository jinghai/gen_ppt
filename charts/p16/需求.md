# P16 页面需求与实现对齐

## 概述
- 页面主题：Lenovo Share of Voice Trend – August ’25（法国市场）。
- 输出目标：更新主趋势折线与渠道分解折线的数据与标签，生成最终 `p16-final.pptx`。
- 原则：严格错误处理，不做兜底；不使用 HTTP 预览或下载；仅在项目根的 `tmp` 目录下读写临时文件。

## 运行流程与职责划分
- `generate_excel.py`
  - 清空页面级 `tmp`；解压 `p16.pptx` 到 `tmp`（包含 `ppt/charts`、`ppt/embeddings` 等）。
  - 从模板图表读取基线数据（优先缓存，其次嵌入工作簿）；并从数据库计算主趋势与渠道分解。
  - 以模板为基线覆盖计算值；在输出的 Excel 中追加 `source=template/computed`；若完全没有 `computed` 覆盖直接抛错。
  - 生成页面根目录的 `./p16_data.xlsx`，包含 `main_trend`、`channel_breakdown`、`summary` 三个表。

- `fill_from_excel.py`
  - 使用已存在的 `tmp/ppt` 内容，不做重新解压；要求 `tmp/ppt/charts` 与 `tmp/ppt/embeddings` 存在，否则报错。
  - 加载 `./p16_data.xlsx`，按 `config.yaml` 的 `chart_mapping` 更新所有图表的数值与字符串缓存，并写入嵌入工作簿。
  - 统一配置外部刷新与标签（`externalData.autoUpdate=1`、百分比 `0%` 格式、标签位置 `top`）。
  - 删除手工百分比标签节点后再启用自动标签，避免重复显示。
  - 更新 `[Content_Types].xml` 为所有嵌入的 `.xlsx` 添加 `<Override>`，确保首次打开即可识别为工作簿。
  - 打包 `tmp` 为 `./output/p16-final.pptx`；保留 `tmp` 以便排查。

## 数据源与过滤
- `metrics-v4-08.db` 表 `brand_metrics_month`：字段 `countryName`、`brand`、`month`、`sov`。
- `neticle-v4-08.sqlite` 表 `mentions_wide`：字段 `countryId`、`keyword_label`、`sourceLabel`、`createdAtUtcMs`。
- 过滤：`country_name=France`、`country_id=39`、`brand_name=lenovo`、`target_month=2025-08`。

## 指标与计算
- SOV 公式：`SOV = (lenovo_mentions / total_mentions) × 100%`，统一保留一位小数。
- 渠道映射：来自 `config.yaml` 的 `channels` 映射（Forum、Online News、Blog、X、Instagram、YouTube）。
- 品牌识别：`keyword_label` 含 `lenovo`（忽略大小写）。

## 配置约定（与实现一致）
- `project.template_ppt`: `./p16.pptx`
- `project.output_dir`: `./output`
- `project.tmp_dir`: `./tmp`
- `project.final_ppt`: `./output/p16-final.pptx`
- `output.excel_file`: `./p16_data.xlsx`（相对路径时落到页面根目录）
- `chart_mapping`: `chart1..chart7` 映射到 `main_trend` 与各渠道 `channel_breakdown`
- `label_mode.auto_labels`: `true`（启用自动标签）

## 图表更新策略
- 主趋势（`chart1.xml`）
  - 覆盖数值与标签缓存（`numCache`/`strCache`），写入嵌入工作簿 `.xlsx`。
  - 清理点级标签覆写，统一由系列级/图表级标签控制。
  - 启用自动刷新与百分比格式；设置标签位置上方。

- 渠道分解（`chart2..chart7.xml`）
  - 同步更新缓存与嵌入工作簿；按 `channel` 分组写入对应图表。
  - 删除手工百分比标签节点，启用自动标签并统一样式。
  - 数值轴移除固定 `min/max`，由数据自动缩放到小数比例。

## 手工标签删除方法（防重复）
- 方法：`_remove_manual_percent_labels(slide1.xml)`。
- 行为：解析 `slide1.xml`，查找文本包含正则 `\d+%` 的形状节点（`p:sp`），将其从 `p:spTree` 移除，并写回文件。
- 调用：在自动标签配置前执行，确保页面仅显示自动标签。
- 错误：缺失 `slide1.xml` 直接抛 `FileNotFoundError`；不做兜底与静默忽略。

## 错误处理原则（不兜底）
- 缺失关键目录或文件（`tmp/ppt/charts`、`tmp/ppt/embeddings`、`[Content_Types].xml`、`slide1.xml`）：立即抛错并终止。
- 数据缺失或不合法（无法解析月份、无 `computed` 覆盖、嵌入工作簿不可读）：立即抛错。
- 任何异常均记录日志并返回失败；不隐藏错误。

## 目录与输出规范
- 临时文件仅位于页面根 `tmp`；不得在其他位置生成。
- Excel 输出位于页面根：`./p16_data.xlsx`。
- 最终 PPT 输出位于 `./output/p16-final.pptx`。

## 依赖与环境
- 必需：`pandas`、`openpyxl`、`lxml`、`PyYAML`。
- 可选：`pyxlsb`（模板图表链接到嵌入工作簿时用于读取 `.xlsb`）。
- 内置：`sqlite3`、`zipfile`、`xml.etree.ElementTree`。

## 验收要点
- 生成的 `p16_data.xlsx` 中 `summary.computed条数 > 0`。
- 打包后的 `p16-final.pptx` 打开即显示最新数据与自动标签，无重复手工百分比。
- 日志中无“警告级兜底”行为，所有异常均明确报错。
