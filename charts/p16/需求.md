# P16 项目需求文档

## 项目概述
基于法国市场数据生成"Lenovo Share of Voice Trend – August '25"图表，展示联想在法国市场的声量份额趋势及各渠道分解。

## 数据源
- **主数据库**: `/Users/jinghai/coder/gen_ppt/input/metrics-v4-08.db`
  - 表: `brand_metrics_month` - 包含按月聚合的品牌指标数据
  - 关键字段: `countryName`, `brand`, `month`, `sov`
  
- **辅助数据库**: `/Users/jinghai/coder/gen_ppt/input/neticle-v4-08.sqlite`
  - 表: `mentions_wide` - 包含原始提及数据，用于渠道分解
  - 关键字段: `countryId`, `keyword_label`, `sourceLabel`, `createdAtUtcMs`

## 目标图表结构

### 1. 主趋势图 (顶部)
- **数据范围**: 2025年3月-8月 (Mar '25 - Aug '25)
- **指标**: Share of Voice (SOV) 百分比
- **数据来源**: `brand_metrics_month` 表中法国联想数据
- **缺失月份处理**: 3-7月使用模板数据，8月使用实际数据

### 2. 渠道分解图 (底部)
- **数据范围**: 2025年5月-8月 (May '25 - Aug '25)
- **渠道映射**:
  - Forum: `forum`
  - Online News: `article`, `frontpage`, `comment`
  - Blog: `blog`
  - Instagram: `instagram`
  - YouTube: `video`
- **数据来源**: `mentions_wide` 表按渠道聚合计算SOV
- **缺失月份处理**: 5-7月使用模板数据，8月使用实际数据

## 数据计算逻辑

### SOV计算公式
```
SOV = (联想品牌提及数 / 所有品牌总提及数) × 100%
```

### 渠道SOV计算
1. 按月份和渠道分组统计各品牌提及数
2. 计算联想在每个渠道的SOV百分比
3. **品牌识别**: 使用 `keyword_label` 字段进行品牌匹配
   - 匹配逻辑: `keyword_label` 包含 "lenovo" (忽略大小写)
   - 实现方式: `df['keyword_label'].str.lower().str.contains('lenovo', na=False)`
   - 优先使用 `keyword_label` 字段，确保品牌识别的准确性和一致性

### 时间范围
- **数据更新期**: 2025年8月 (month = '2025-08')
- **历史数据**: 使用模板中的缓存数据
- **国家过滤**: `countryName = 'France'` 或 `countryId = 39`

## 输出要求

### 1. Excel数据文件
- **路径**: `charts/p16/output/p16_data.xlsx`
- **工作表结构**:
  - `main_trend`: 主趋势数据 (月份, SOV%)
  - `channel_breakdown`: 渠道分解数据 (月份, 渠道, SOV%)
- **数据格式**: 便于人工检验和修改

### 2. PPT文件
- **模板**: `charts/p16/p16.pptx`
- **输出**: `charts/p16/output/p16-final.pptx`
- **要求**: 
  - 保持模板格式和样式
  - 嵌入可编辑的图表数据
  - 处理图表缓存更新

## 技术实现

### 配置文件
- 页面级配置: `charts/p16/config.yaml`
- 临时目录: `charts/p16/tmp/`
- 不依赖全局配置文件

### 核心脚本
1. `generate_excel.py`: 数据提取和Excel生成
2. `fill_from_excel.py`: PPT模板数据填充
3. `build.py`: 一键构建脚本

### 图表映射
- chart23.xml: 主趋势图
- chart22.xml: Forum渠道
- chart21.xml: Online News渠道  
- chart17.xml: Blog渠道
- chart18.xml: Instagram渠道
- chart19.xml: YouTube渠道
- chart20.xml: (备用)

## 数据质量要求
- 确保法国数据的准确性
- 处理缺失数据的回退策略
- 保持与模板数据的一致性
- 验证SOV计算的合理性 (0-100%)

## 颜色和样式
- 主色调: 红色 (#FF0000)
- 数据点: 红色圆点
- 文字: 黑色数值标注
- 保持与原模板一致的视觉风格