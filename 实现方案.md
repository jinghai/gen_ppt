# LRTBH 图表重填充项目实现方案

本方案用于在 `charts` 目录内，基于模板 `ppt/input/LRTBH-unzip`（内部 `ppt/charts`），解析并重填充所有页面图表的数据，保持样式与文本完全一致；按统一配置的时间范围（`update.start_date`/`update.end_date`）进行增量更新，超出范围的数据沿用模板原文（模板中已有的缓存/字面值），后续迭代可补齐历史数据。

> 重要澄清（新增）：由于当前数据源仅包含 2025-08，若图表时间范围覆盖到我们尚未具备的数据（例如 2025-07），则对这些“缺失日期/类别”的数据点，必须保留并使用模板原始图表中的缓存值（numCache/strCache/numLit/strLit）。当后续数据源补齐这些日期的数据时，填充逻辑将以我们数据源为准覆盖对应点。该行为由统一配置中的开关 `fill_policy.keep_original_for_missing` 控制，默认开启（true）。

## 目标与范围
- 保持样式与文本：不修改 PPT 的主题、母版、字体、颜色及页面文本，仅更新图表数据。
- 独立工程：所有代码与输出位于 `charts/` 内，生成每页单独的 PPT，并最终合并为完整报告。
- 增量更新：本次仅更新 8 月数据；8 月之前的数据按模板原文保留。
- 统一配置：新增 `charts/config.yaml`，集中管理更新月份、数据源路径、渠道归类等。

## 样式一致性要求（严格遵守“与 PPT 原文完全一致”）
- 保留所有图表样式节点，不做任何改动：
  - `c:spPr`（形状/边框/填充）、`c:plotArea`（网格/背景）、`c:legend`（位置/排列）、`c:dLbls`（显示值/百分比/类别/小数位）、`c:numFmt`（数字格式）、`c:axId`（轴绑定）。
  - 轴设定与刻度：`min`/`max`/`majorUnit`、`tickLblPos`、`majorGridlines`/`minorGridlines` 保持一致；不更改轴位置 `axPos`。
  - 系列风格：`c:marker`/`c:line` 相关的线宽、颜色、点样式；饼/环形的起始角度、间隙宽度、重叠、堆叠/簇状按模板保持。
  - 配色与顺序：沿用主题配色与系列顺序，不插入或删除系列（除非模板本身如此要求）。
- 页面文本与布局：不修改任何 `p:sp` 文本（`p:txBody`/`a:t`）；不调整版式位置或尺寸。
- 数据替换方式：仅将数据注入为 `numLit/strLit` 字面值；保留 `externalData` 引用但不操作 `xlsb`，避免破坏样式关系与缓存机制。
- 构建与合成：复制并复用 `theme`、`slideMasters`、`rels`，不引入新的样式资源；最终合成的 `presentation.xml` 中仅维护页面列表，不改动样式定义。

## 需求总览与补充
- 仅更新 2025-08 的图表数据；8 月之前沿用模板原文数据（`numCache`/`strCache` 或 `numLit`/`strLit`）。
- 根目录需有总的 `readme.dm`（已新增），用于快速上手、配置说明与使用约定。
- PPT 页面文字内容原样保留，仅更新图表数据。
- 统一采用 `data.json` 与 `final_data.json` 存储；如未提供 JSON，将回退使用 CSV（`data.csv`/`final_data.csv`）。
- `fill.py` 优先读取 JSON（`final_data.json`→`data.json`），否则回退到 CSV（`final_data.csv`→`data.csv`）。
- 保留原始缓存快照 `original_*.json`；通过 `p10/validate.py` 验证原始数据与模板一致、数据量不小于原始。
- 统一配置文件：设置更新月份、渠道归类（参考 `Media_Channels_ShareofVoice.yaml#L19-48`）、数据库路径等。
- 目录与文件命名：页面单图用 `pXX/`；同页多图用 `pXX-chartY/`；各目录包含 `readme.dm/query.sh/data.csv/final_data.csv/fill.py/build.py/preview.png`。

## 目录结构规划
```
charts/
  readme.dm                  # 总说明与快速上手（新增）
  实现方案.md                # 本文件：详细方案、需求与进度跟踪
  requirements.txt           # 图表工程依赖（独立于根 requirements）
  config.yaml                # 统一配置：时间范围、数据源、渠道映射等
LRTBH-unzip/               # 模板已解压（新标准，位于 ppt/input 下）
  tools/                     # 通用工具脚本
    parse_all.py             # 解析模板得到索引 index.json
    scaffold.py              # 依据索引生成每页/图表实现脚手架
    build_all.py             # 合并各页为完整 PPT
    xml_fill.py              # 通用 XML 注入工具（numLit/strLit）
  index.json                 # 模板解析索引（页面→图表→类型→关系→样式）
  output/                    # 生成的单页 PPT 与最终合成 PPT
  p10-chart1/                # 示例：第 10 页图表 1（若整页单图则用 p10/）
    readme.dm                # 该图表的需求、设计、实现与执行方法
    query.sh                 # CLI 查询脚本（导出 CSV）
    data.json                 # 查询结果的中间数据（统一 JSON，若无则回退 CSV）
    final_data.json           # 最终填充数据（可手工修订；存在则覆盖 data.json）
    fill.py                  # 将数据写入对应 chart 的 XML（优先 JSON，其次 CSV）
    build.py                 # 打包生成单页 PPT：p10-chart1.pptx
    preview_original.png     # 快速预览原始数据（用于校验，不是交付物）
  p10-chart2/
    ... 同上 ...
  pXX[-chartY]/              # 其它页面按相同规则创建
```

## 统一配置（config.yaml 示意）
```yaml
project:
template_root: ppt/input/LRTBH-unzip
  output_root: charts/output
update:
  start_date: "2025-08-01"
  end_date: "2025-08-31"
channels_map_file: ../Media_Channels_ShareofVoice.yaml
fill_policy:
  keep_original_for_missing: true       # 缺失数据回退到原始图表缓存；数据源有值则覆盖
  pre_aug: keep_template_cache          # 非更新范围保留模板缓存
  aug_update: replace_or_merge          # 更新范围：折线/散点按日覆盖，饼/柱按当月聚合
  axis_day_base: 20300                  # 日期轴基准（如 p10 散点）
  dedup: mention_id
  sentiment_labels: [Positive, Neutral, Negative]
  channel_order: ["Online News", "Forum", "Blog", "X", "Instagram", "YouTube"]
output:
  final_ppt: charts/output/LRTBH-final.pptx
```

- 渠道归类参考：`Media_Channels_ShareofVoice.yaml#L19-48` 用于将 `sources.name` 归并到目标渠道（含 Twitter/X、Instagram、YouTube 等）。
- 数据库路径通过 `config.yaml` 注入，所有查询用命令行 `sqlite3` 导出，不在脚本中直接打开大文件。

## 解析与索引（tools/parse_all.py）
- 扫描 `slides/_rels/slide*.xml.rels`，枚举每页所有 `chart*.xml` 关系，并定位到 `ppt/charts/chart*.xml`。
- 解析图表类型（pie/bar/line/scatter/doughnut 等）、系列数量与每系列的 `xVal/yVal/cat` 引用或缓存（`numRef/strRef` 与 `numCache/strCache`）。
- 如果存在 `externalData r:id=...`，在对应 `chart*.xml.rels` 中定位 `ppt/embeddings/*.xlsb`；作为备用数据源解析（仅在确需读取类别或原始数据时使用）。
- 提取页面文本框（`a:t`）作为语义线索，辅助给出“图表含义”，并编入 `index.json`。

## 数据映射原则（与 SQL 模板）
- 情绪分布（饼/环形）：
  - SQL：`SELECT sentiment, COUNT(*) FROM mentions WHERE publish_date BETWEEN '2025-08-01' AND '2025-08-31' GROUP BY sentiment;`
  - 类别映射：`[Positive, Neutral, Negative]`；若模板有固定顺序，按顺序输出。
- 日趋势（折线/散点）：
  - SQL：`SELECT publish_date, sentiment, COUNT(*) FROM mentions WHERE publish_date BETWEEN '2025-08-01' AND '2025-08-31' GROUP BY publish_date, sentiment;`
  - x 轴：映射为模板所用刻度（如 20301–20331 → day = x - 20300）。
- 渠道占比（柱/堆叠/饼）：
  - 先用 `Media_Channels_ShareofVoice.yaml` 归并 `sources.name` 到渠道，再 `GROUP BY channel` 聚合。
  - SQL 示例：`SELECT channel, COUNT(*) FROM mentions WHERE publish_date BETWEEN '2025-08-01' AND '2025-08-31' GROUP BY channel;`
- 去重与口径：
  - 默认按 `mention_id` 去重；如页面特殊口径，在各图表 `readme.dm` 明确注释。

## 填充策略（tools/xml_fill.py）
- 保留样式：不改动 `c:spPr`、`c:dLbls`、`c:legend`、`c:axId`、`c:gridlines`、`c:numFmt`、`c:marker` 等样式节点。
- 数据写入：将 `c:ser` 下的 `numRef/strRef` 替换为 `numLit/strLit`，写入 `c:pt` 与 `c:v`；保留 `externalData` 引用但不操作 `xlsb`。
- 缺失数据回退（新增开关）：
  - 类别型图（line/bar/pie/doughnut/area）：以模板原始 `c:cat` 的标签顺序为基准，仅对我们数据源提供的标签覆盖值；未提供的标签保持原始值。
  - 散点/折线（日序列）：按 `axis_day_base + day` 对齐 x 值，仅覆盖我们数据源提供的 x 上的 y 值；其它 x 继续沿用原始缓存；若我们新增了过去月份的数据，则自动覆盖对应 x。
- 每个图表目录保留 `final_data.json`：`fill.py` 优先读取该文件；需要人工修订时只改我们负责的月份数据；若仅有 CSV，将自动回退。

## 单页构建与最终合成
- 单页：复制 `slideN.xml`、其 `_rels`、引用的 `chart*.xml`、`media`、`theme`、`slideMasters`，打包为 `pXX[-chartY].pptx`；页面文本与布局保持原样。
- 合成：`tools/build_all.py` 汇总各页为 `output/LRTBH-final.pptx`，复用同一母版与主题，更新 `presentation.xml` 中的 `sldIdLst` 与 `_rels`。

## 执行流程（示例）
1) 解析与脚手架：
```
python charts/tools/parse_all.py --ppt ppt/input/LRTBH-unzip --out charts/index.json
python charts/tools/scaffold.py --index charts/index.json --pages 10 11 12
```
2) 转换与填充（以 p10-chart2 为例）：
```
# 若源数据为 CSV，先转换为统一 JSON
python charts/tools/convert_to_json.py --chart_dir charts/p10-chart2 --type scatter  # 或 category

# 人工修订 final_data.json（如需），随后执行填充与构建
python charts/p10-chart2/fill.py
python charts/p10-chart2/build.py
```
3) 合成完整 PPT：
```
python charts/tools/build_all.py --out charts/output/LRTBH-final.pptx
```

## 依赖
- `lxml`：高性能 XML 解析与写入
- `typer` 或 `click`：轻量 CLI
- `pandas`（可选）：合并 CSV（不直接读库）
- `pyxlsb`（可选，仅在确需读取嵌入工作簿时）
- `matplotlib`：预览图生成（`preview_original.png`）
- 命令行：`sqlite3`（导出 CSV，避免代码直接读大库）

`charts/requirements.txt` 将独立维护上述依赖。

## 质量保障与回滚
- 备份：填充前备份 `chart*.xml` 原文件；生成 diff 报告。
- 校验：`charts/p10/validate.py` 自动验证原始数据与模板一致、数据量不小于原始；并为每个图表生成 `preview_original.png`（`charts/p10/gen_preview.py`）用于人工快速比对（最终交付仍以 PPT 为准）。
- 文件校验方式：禁止使用本地 HTTP 服务进行下载或预览；所有校验以“直接在文件路径读取与检查包结构/内容类型”为准。
- 回滚策略：若填充失败或样式异常，可恢复备份并仅保留原模板缓存。

## 解压完整性验证（完整性检查）
- 目标：确认 `input/LRTBH.pptx` 解压至 `ppt/input/LRTBH-unzip` 的内容完整、引用一致，避免遗漏图表导致解析失败。
- 检查项：
  - 计数一致性：`charts/` 中 `chart*.xml` 数量与 `slides/_rels/slide*.xml.rels` 内引用的唯一图表文件数一致。
  - 关系完整性：每个被引用的 `chart*.xml` 均存在对应 `charts/_rels/chart*.xml.rels`；若含 `<c:externalData r:id=...>`，则 `.rels` 中必须有该 `r:id` 的目标，且目标 `embeddings/*.xlsb` 存在。
  - 类型与系列：每个 `chart*.xml` 至少包含一个类型节点（如 `<c:barChart>`/`<c:lineChart>`/`<c:pieChart>`/`<c:scatterChart>` 等），且存在 `c:ser` 系列。
  - 幻灯片覆盖：`slides/` 下 `slide*.xml` 与 `_rels` 数量合理；若模板本应多页但当前仅见少量页（例如仅 `slide10.xml`），判定为解压不完整。
  - 主题与母版：`theme/` 与相关母版/布局资源齐备。
- 实施方法：新增 `charts/tools/verify_unzip.py` 输出 `charts/output/unzip_report.json` 与 `unzip_report.md`，列出缺失清单与覆盖率（图表总数、被引用图表数、缺失关系、缺失 embeddings、类型分布）。
- 命令示例：
- `python charts/tools/verify_unzip.py --root ppt/input/LRTBH-unzip --out charts/output/unzip_report.json`
- 处理策略：发现缺失时，先完整重新解压或从原 PPT 定点补齐缺失文件；在完整性通过前，阻断填充流程。
## 法国市场与品牌范围（更新）
- 分析对象：`lenovo` 及竞品 `dell`、`hp`、`asus`、`acer`、`apple`、`samsung`。
- 国家过滤：法国（`countryId: 39` / `countryId` 以库字典为准）。
- 配置更新：`charts/config.yaml` 建议使用如下过滤项驱动查询与填充：
  - `filters.countryId: [39]`
  - `filters.brands: [lenovo, dell, hp, asus, acer, apple, samsung]`
- 状态：已为“联想法国”写入国家/品牌口径；本次补充竞品列表，后续若页面存在独特口径（类别顺序、轴基准、聚合粒度等），将抽取到该页实现目录，`charts/` 仅保留公共配置。

## 渠道映射（X → Twitter）
- PPT 中的 `X` 渠道对应数据源中的 `twitter`。
- 渠道归并仍由 `Media_Channels_ShareofVoice.yaml` 驱动；如模板使用 `X` 展示，则在归并层将 `twitter` 映射为 `X` 标签以保持一致。
- 详细：
···# 渠道映射：将 sources.name 归并为目标渠道。
# 注意：'X' 代表 Twitter（含转推/回复/引用）。
channels:
  Forum:
    - forum
    - forum_aggregator
  Online News:
    - article
    - frontpage
    - article_aggregator
    - frontpage_aggregator
    - comment
    - comment_article
  Blog:
    - blog
    - blog_aggregator
    - comment_blog
  X:
    - twitter
    - twitter_reply
    - twitter_retweet
    - twitter_quoted
  Instagram:
    - instagram
    - instagram_post
    - instagram_comment
    - instagram_reply
  YouTube:
    - youtube
    - video
···

## 数据源与表结构引用（来源）
- 参考字典与宽表 schema（用于查询、聚合与字段对齐）：
  - `/Users/jinghai/coder/neticle-data-sync_v1/schemas/countries.json`
  - `/Users/jinghai/coder/neticle-data-sync_v1/schemas/keywords.json`
  - `/Users/jinghai/coder/neticle-data-sync_v1/schemas/mentions_wide.json`
  - `/Users/jinghai/coder/neticle-data-sync_v1/schemas/sources.json`
- 字段对齐以 `mentions_wide.json` 为基准；如遇字段缺失或命名差异，优先在指标侧补齐派生列，再回填至图表填充。

## 指标实现与统计库（来源）
- 统计库：`/Users/jinghai/coder/neticle-data-sync_v1/data/metrics_v5.db`（SQLite）。
- 指标实现参考：`/Users/jinghai/coder/neticle-data-sync_v1/指标实现.md`（V6 技术文档）。现阶段图表取自现有聚合结果；若需补充字段或口径，优先在指标实现中新增派生列，再驱动图表填充。
- 集成策略：图表填充优先使用“最终聚合结果”而非原始 mentions，避免在图表侧做复杂计算。

## 页面优先级计划（新增）
- 高优先级：10，13，14，15，16，18，21，24，25，29，30，31
- 中优先级：12，17，21，22，23，26
- 低优先级：8，19，21，22，27
- 说明：实现过程中如发现某页存在特性配置（例如轴基准、类别顺序、特殊聚合），该配置应抽取到该页目录的 `readme.md/config.local.yaml` 或 `fill.py`，`charts/` 仅保留公共配置。

## 任务规划（刷新）
- 完善 p10 并验证生成的 `charts/output/p10.pptx` 能打开；若失败，立即执行打包结构校验并修复（关系、内容类型、母版/版式）。
- p10 完成后，按同样模式继续批量推进其它页面（依优先级计划）。
- 每完成一个页面：更新该页目录的 `readme.md`（口径与数据说明）、生成 `preview.png`、并在本文档“进度跟踪”与“问题与解决方案记录”登记。

## 进度跟踪（迭代中）
- [x] 验证解压完整性并生成报告（`tools/verify_unzip.py` → `charts/output/verify_unzip.json`、`verify_unzip.md`）
- [x] 统计图表总数、类型分布与被引用覆盖率（`tools/parse_index.py` → `charts/output/index.json`）
- [x] 完成通用填充与脚手架（`charts/tools/fill_chart_xml.py`、`charts/tools/scaffold_p10.py`）
- [x] p10 两图（slide10: chart8、chart9）数据填充并修复散点注入逻辑（支持 `xVal/yVal` 的 `numCache`）
- [x] 构建单页 `p10.pptx`（`charts/p10/build.py` → `charts/output/p10.pptx`）
- [x] 合成最终 PPT（`charts/tools/build_all.py` → `charts/output/LRTBH-final.pptx`）
- [x] 将完整性验证纳入构建前置检查（作为合成前置自检）
- 计划页（高优先级）：10，13，14，15，16，18，21，24，25，29，30，31
- 计划页（中优先级）：12，17，21，22，23，26
- 计划页（低优先级）：8，19，21，22，27
- [x] 批量创建页面脚手架（p8, p12, p13, p14, p15, p16, p17, p18, p19, p21, p22, p23, p24, p25, p26, p27, p29, p30, p31），已写入 `readme.md` 与 `config.yaml`
- [x] 更新全局构建器聚合页级 replace_charts，保证合成覆盖所有页面图表
- [x] 批量运行页面构建（含数据生成与填充），模式 `--mode both`，已完成高/中/低优先级所有页
- [x] 合成最终 PPT 并校验产物存在（`charts/output/LRTBH-final.pptx`，当前大小约 6.4M）
- [x] 启动输出目录预览服务用于快速检查构建产物（本地 `http://localhost:8000/`）


## 进度更新机制
- 每次完成一个阶段任务后，立即更新本文件的进度清单与“进度日志”。
- 遇到问题，写入“问题与解决方案记录”，同时新增相应任务条目，指明负责人与优先级。
- 记录格式：`YYYY-MM-DD HH:MM` + 简述 + 影响范围 + 下一步动作。
- 文档变更原则：只增不删；关闭任务需标注日期与产物链接（如 `preview.png`、`pXX[-chartY].pptx`）。

## 问题与解决方案记录（滚动维护）
- 2025-10-26 观察：`slides/` 目录当前仅有 `slide10.xml`，初步判断解压不完整。
  - 影响：可能遗漏其它页面的图表与文本，导致解析覆盖率不足。
- 方案：实现并运行 `tools/verify_unzip.py`；若不完整则重新完整解压 `input/LRTBH.pptx` 到 `ppt/input/LRTBH-unzip`。
- 2025-10-26 修复：p10 注入报错（`NoneType` 作为 `_parent`），根因是散点图缺少 `c:val`，需写入 `xVal/yVal`。
  - 方案：增强 `charts/tools/fill_chart_xml.py`，新增 `replace_num_cache`，并在 `scatterChart` 路径下写入 `c:xVal/c:yVal` 的 `numCache` 与 `c:pt`；保留样式与 `externalData`。
  - 结果：`charts/tools/fill_p10.py` 运行成功，更新了 `charts/chart8.xml` 与 `charts/chart9.xml`。
- 2025-10-26 产物：
  - 单页：`charts/output/p10.pptx`（从 `slide10.xml` 构建，含图表与图片）。
  - 合成：`charts/output/LRTBH-final.pptx`（基于原始 `input/LRTBH.pptx` 替换 `ppt/charts/chart8.xml` 与 `ppt/charts/chart9.xml`）。
  - 下一步：页面视觉校验（人工预览）与批量推进其它页面。
- 2025-10-26 遗留：`charts/output/p10.pptx` 在 WPS 侧仍提示“在试图打开文件时遇到错误”，暂不解决，后续统一排查；请在本地直接通过文件路径校验（不使用 HTTP 服务）。

## 备注与假设
- 当前迭代仅更新 2025-08；8 月之前“按原文数据填充”理解为：保留模板中的 `numCache/strCache/numLit/strLit` 值，不做覆盖。
- 若个别图表的轴刻度、类别顺序或标签口径与数据库口径不一致，以模板样式与顺序为准；在各 `readme.dm` 明确说明。
- 渠道归类以 `Media_Channels_ShareofVoice.yaml#L19-48` 为准：例如 `X` 表示 Twitter（含转推/回复/引用），`YouTube` 包含 `youtube` 与 `video` 等。

---
如无问题，我将按此方案先落地通用解析与脚手架，并从 p10 开始示范实现，随后批量推进其它页面。

## 原始版重建与校验（新增）
- 新增脚本：`charts/tools/build_all_original.py`
- 功能：
  - 扫描 `charts/**/chart_path.txt`，读取每个图表目录下的 `original_*`（`original_labels.json`、`original_series.json`、`original_scatter.json`）。
- 以模板解压目录 `ppt/input/LRTBH-unzip` 中的样式为基线，重写对应 `chart*.xml` 的数据缓存（`numCache/numLit`、`strCache/strLit`），生成新的 `LRTBH-final-original.pptx`。
  - 解析并对比新旧 PPT 中图表的数据（非字节级，按数值/标签一致性），输出校验报告（JSON 与 Markdown）。
- 输出：
  - `charts/output/LRTBH-final-original.pptx`（使用 original_* 数据重建的原始版）
  - `charts/output/original_rebuild_validate.json`（每个图表的校验结果）
  - `charts/output/original_rebuild_validate.md`（摘要与差异列表）
- 用法：
  - 生成并校验：`python3 charts/tools/build_all_original.py`
  - 严格模式（有不一致则退出码为 2）：`python3 charts/tools/build_all_original.py --strict`
- 判定规则：
  - 类别型图：比较 `labels` 与每个系列 `values` 是否完全一致（按解析后的数值/字符串比对）。
  - 散点图：比较每个系列的 `x` 与 `y` 序列是否完全一致。
- 说明：
  - 此校验用于验证 `original_*` 是否忠实反映原始图表数据；若出现不一致，请回查对应 `pXX/chartYYY` 的 `original_*` 来源与生成流程（`extract_chart_cache.py`、`generate_original_cache.py` 与 `sync_original_subdir.py`），修复后再次运行校验。