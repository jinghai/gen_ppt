# 通用需求与规范（PPT单页数据生成体系）

适用范围：统一 charts 目录下各页面（如 p10/p13/p16/p18/p29…）的实现规范，确保数据生成、嵌入、打包与校验一致可控、可复用、可审计。

## 目录结构规范
- 页面目录：`charts/<page>/`
  - `config.yaml`：页面级配置（数据源、过滤、月份、阈值、输出策略）。
  - `generate_excel.py`：抽取模板、计算数据、生成汇总 Excel 与嵌入工作簿。
  - `fill_from_excel.py`：将 `output/<page>_data.xlsx` 写入 `chart*.xml` 的 `numCache`，设置 `externalData/autoUpdate=1`，写 `_rels` 指向嵌入 xlsx。
  - `build.py`：仅用页面级 `tmp` 打包为单页输出，必要时执行附加替换（如排名文本）。
  - 模板：`<page>.pptx`（页面模板）。
  - 输出：`output/<page>-final.pptx`（最终单页）。
  - 临时：`tmp/ppt`（模板解压与中间产物，仅页面级）。
- 根级临时：`tmp/`（仅用于短期调试脚本或临时数据；禁止随地生成临时代码）。

## 构建流程规范
1) 模板抽取（`generate_excel.py`）
   - 解压模板到 `charts/<page>/tmp/ppt`，优先读取嵌入 xlsx 数据，必要时解析 `chartXML`。任一关键模板数据缺失必须报错。
2) 最新计算（`generate_excel.py`）
   - 连接数据库，按 `config.yaml` 的国家、品牌与月份计算最新值，用新值覆盖对应模板月份的数据；缺失月份保留模板值，并在汇总 Excel 标注来源为 `template`（显式，不兜底）。
3) 写出成果（`generate_excel.py`）
   - 生成 `charts/<page>/output/<page>_data.xlsx`（Sheet 横向结构，含 `Source=template|computed|fallback`），并在 `tmp/ppt/ppt/embeddings/` 写入嵌入 xlsx（供图表引用）。
4) 图表填充（`fill_from_excel.py`）
   - 更新 `chart*.xml` 的 `numCache` 与 `_rels`（目标为嵌入 xlsx），将 `externalData/autoUpdate` 设为 1。颜色与系列顺序严格保持模板。
5) 打包输出（`build.py`）
   - 仅使用页面级 `tmp` 打包为单页 `output/<page>-final.pptx`。如页面包含排名文本等动态元素，需在打包阶段按汇总数据更新（遇缺失必须报错）。

## 配置规范（`charts/<page>/config.yaml`）
- `project`：`name`（说明性）、`template_file`（模板名）、`output_dir`、`tmp_dir`。
- `data_sources`：库路径（如 `input/neticle-v4-08.sqlite`、`input/metrics-v4-08.db`）、表名（如 `mentions_wide`）、时间戳列（毫秒，如 `createdAtUtcMs`）、国家列（如 `countryId`）。
- `filters`：`country_id`、`brand_key`、`keyword_like`（大小写不敏感）。
- `sentiment.thresholds`：`positive_min`、`negative_max`、`column`（如 `polarity`）。
## 品牌相关提及识别规则（严格模式）

### 数据源要求
- **主表**：`mentions_wide`（宽表结构）
- **国家过滤**：`countryId = 39`（法国市场）
- **必需字段验证**：
  - `keyword_label`：品牌识别的唯一字段
  - `countryId`：国家过滤字段
  - `sentiment`：情感分析字段
  - `date`：时间字段

### 品牌识别规则（严格模式）
- **唯一匹配字段**：`keyword_label`
- **匹配逻辑**：
  - **Lenovo品牌**：`keyword_label LIKE '%lenovo%'`（大小写不敏感）
  - **其他品牌**：`keyword_label LIKE '%{brand.lower()}%'`
- **错误处理**：
  - 如果 `keyword_label` 字段不存在：**立即报错，终止执行**
  - 如果 `countryId` 字段不存在：**立即报错，终止执行**
  - **禁止回退**：不允许使用其他字段（如 `content`、`title` 等）作为备选

### 百分比计算规则，最大余数法说明**: 
- 先按精确配额取地板值
- 再按余数大小分配剩余点数
- 严格保证总和为100%，避免四舍五入误差

### SQL查询模板
```sql
-- 品牌数据查询（以Lenovo为例）
SELECT strftime('%Y-%m', date) as month,
       SUM(CASE WHEN sentiment > {lovers_min} THEN 1 ELSE 0 END) as lovers,
       SUM(CASE WHEN sentiment BETWEEN {neutral_min} AND {neutral_max} THEN 1 ELSE 0 END) as neutral,
       SUM(CASE WHEN sentiment < {haters_max} THEN 1 ELSE 0 END) as haters,
       COUNT(*) as total
FROM mentions_wide 
WHERE countryId = {country_id} 
  AND keyword_label LIKE '{keyword_like}'
GROUP BY month
ORDER BY month;

-- 多品牌排名查询
SELECT brand, 
       AVG((lovers_pct - haters_pct)) as net_lovers_avg
FROM (
    SELECT '{brand}' as brand,
           strftime('%Y-%m', date) as month,
           (SUM(CASE WHEN sentiment > {lovers_min} THEN 1 ELSE 0 END) * 100.0 / COUNT(*)) as lovers_pct,
           (SUM(CASE WHEN sentiment < {haters_max} THEN 1 ELSE 0 END) * 100.0 / COUNT(*)) as haters_pct
    FROM mentions_wide 
    WHERE countryId = {country_id} 
      AND keyword_label LIKE '%{brand.lower()}%'
    GROUP BY month
) 
GROUP BY brand
ORDER BY net_lovers_avg DESC;
```

### 字段验证函数
```python
def _get_available_brand_columns(cursor, table_name):
    """验证数据库表结构，确保必需字段存在"""
    cursor.execute(f"PRAGMA table_info({table_name})")
    columns = [row[1] for row in cursor.fetchall()]
    
    required_fields = ['keyword_label', 'countryId', 'sentiment', 'date']
    missing_fields = [field for field in required_fields if field not in columns]
    
    if missing_fields:
        raise ValueError(f"Missing required fields in {table_name}: {missing_fields}")
    
    return columns

def _brand_where_and_params(brand_name, keyword_like, country_id):
    """生成严格的品牌过滤条件"""
    if not keyword_like:
        raise ValueError(f"keyword_like pattern is required for brand: {brand_name}")
    
    where_clause = "countryId = ? AND keyword_label LIKE ?"
    params = [country_id, keyword_like]
    
    return where_clause, params
```

### 配置参数规范
```yaml
# config.yaml 中的品牌配置
filters:
  keyword_like: "%lenovo%"  # 必需，不允许为空

data_sources:
  country_id: 39           # 必需，法国市场
  neticle_table: "mentions_wide"  # 必需，宽表

# 多品牌排名配置
ranking:
  brands: ["lenovo", "hp", "dell", "asus", "acer"]  # 品牌列表
```

### 严格模式特性
1. **无回退机制**：任何关键字段缺失都会立即报错
2. **字段验证**：启动时验证所有必需字段存在
3. **参数验证**：所有配置参数都必须提供，不允许默认值掩盖配置错误
4. **数据完整性**：确保所有计算都基于真实的数据库数据
5. **错误透明**：所有错误都会详细记录并立即抛出

### 实施建议
- **新项目**：直接采用严格模式
- **现有项目**：逐步迁移，先添加字段验证，再移除回退机制
- **测试验证**：每个项目都应包含字段验证测试
- **文档同步**：配置文件和代码注释都应反映严格模式要求
  
## 嵌入数据与图表关系规范
- 图表关系：`ppt/charts/chart*.xml` 与 `_rels/chart*.xml.rels` 指向上述嵌入 xlsx；`externalData/autoUpdate=1`，`numCache` 同步更新为最新值。
- 颜色与系列顺序：严格沿用模板，代码不重绘颜色、不改变系列顺序。

## 错误处理与兜底策略
- 不允许任何“兜底”掩盖错误：关键文件缺失、模板数据抽取失败、月份不匹配、Ranking 数据缺失，均应显式报错并中止。
- 仅允许“保留模板值并显式标注来源”的场景：数据库缺失或总量为 0 的月份保留模板值，但在汇总表 `Source` 列用 `template` 或 `computed` 明确标识。

## 依赖与环境规范
- 依赖最小化：标准库 + `openpyxl`。在 `requirements.txt` 管理版本；缺失依赖应报错，禁止静默降级或下载。
- 禁止使用 HTTP 预览或下载；所有输出在本地目录内完成。
- Python 版本：3.10+（建议，确保 `zipfile`、`sqlite3` 与 `lxml`/`etree` 等行为一致）。

## 临时与调试文件
- 页面级临时：仅使用 `charts/<page>/tmp`（模板解压与中间产物）。
- 根级调试：若确需调试脚本或临时数据，仅可放在项目根 `tmp/`；禁止在其他位置随意生成临时文件。

## 输出与命名规范
- 汇总 Excel：`charts/<page>/output/<page>_data.xlsx`（Sheet：`MainTrend`、`Ranking`、`Lovers`、`Neutral`、`Haters`；横向列随月份变化，含 `Source` 行）。
- 单页 PPT：`charts/<page>/output/<page>-final.pptx`。
- 嵌入工作簿：`charts/<page>/tmp/ppt/ppt/embeddings/Microsoft_Office_Excel_Binary_Worksheet{1..X}.xlsx`。

## 统一校验清单（构建后）
- `ppt/charts/chart1...X.xml` 的 `externalData/autoUpdate=1`。
- `ppt/charts/_rels/chart*.xml.rels` 指向对应嵌入 xlsx。
- `[Content_Types].xml` 覆盖存在对应 `slide1.xml` 与嵌入工作簿条目。
- 排名文本（如有）：`slide1.xml` 中的 `#数字` 与汇总 `Ranking/Position` 一致，数量匹配，否则报错。
- 嵌入工作簿存在且非空，尺寸合理。

## 执行方式（统一）
- 在页面目录执行：`python charts/<page>/build.py`
  - 顺序：`generate_excel.py` → `fill_from_excel.py` → 打包输出。